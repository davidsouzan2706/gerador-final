<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Roteiros Virais v2.0 - O Painel do Projeto</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF para gera√ß√£o de PDF (ainda inclu√≠do, mas n√£o usado para download principal) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Fontes Google - Carlito para legibilidade -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carlito:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    <style>
        /* ========================================================== */
        /* ==================== ESTILOS GERAIS ==================== */
        /* ========================================================== */
        /* Vari√°veis CSS para cores consistentess e f√°cil manuten√ß√£o */
        :root {
            --primary-color: #4f46e5; /* Indigo-600 */
            --primary-hover: #4338ca; /* Indigo-700 */
            --secondary-bg: #e0e7ff; /* Indigo-100 */
            --secondary-text: #4338ca; /* Indigo-700 */
            --secondary-hover: #c7d2fe; /* Indigo-200 */
            --success-color: #10B981; /* Green-500 */
            --success-hover: #059669; /* Green-600 */
            --text-dark: #1f2937; /* Gray-800 */
            --text-medium: #4b5563; /* Gray-600 */
            --text-light: #6b7280; /* Gray-500 */
            --bg-light: #f9fafb; /* Gray-50 */
            --border-light: #e5e7eb; /* Gray-200 */
        }

        body {
            font-family: 'Carlito', sans-serif;
            background-color: #f0f2f5; /* Cinza bem claro */
            color: var(--text-dark); /* Cor de texto padr√£o para modo claro */
        }
        .dark body {
            background-color: #111827; /* Cinza 900 */
            color: #d1d5db; /* Cor de texto padr√£o para modo escuro */
        }
        .container {
            max-width: 1024px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff; /* Branco */
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        }
        .dark .container {
            background-color: #1f2937; /* Cinza 800 */
        }
        .input-group label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            display: block;
        }
        /* ========================================================== */
        /* ======== ESTILIZA√á√ÉO DEFINITIVA DE INPUTS E FORMS ======== */
        /* ========================================================== */
        /* Classe Mestra para Fundos de Componentes */
        .card-background {
            background-color: #ffffff; /* Padr√£o (Claro) */
            border: 1px solid var(--border-light);
        }
        .dark .card-background {
            background-color: #1f2937; /* Escuro */
            border: 1px solid #4b5563;
        }

        /* --- ESTADO PADR√ÉO (MODO CLARO) --- */
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none !important;
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2) !important;
            background-color: #ffffff !important; /* Explicitly white on focus in light mode */
        }
        /* --- ESTADO MODO ESCURO --- */
        .dark .input-group input:focus,
        .dark .input-group select:focus,
        .dark .input-group textarea:focus {
            border-color: #6366f1 !important; /* indigo-500 */
            background-color: #4b5563 !important; /* gray-600 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3) !important;
        }
        /* --- CORRE√á√ÉO PARA O PLACEHOLDER --- */
        .dark .input-group input::placeholder,
        .dark .input-group textarea::placeholder {
            color: #9ca3af; /* gray-400 */
        }
        /* Cor de texto para elementos no modo escuro */
        .dark h1, .dark h2, .dark h3, .dark h4, .dark label {
            color: #f3f4f6;
        }
        .dark .input-group input, .dark .input-group select, .dark .input-group textarea {
            color: #f9fafb;
        }


        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: inline-flex; /* Para alinhar texto e spinner/√≠cone */
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            white-space: nowrap; /* Evita que o texto do bot√£o quebre linha */
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: #ffffff;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }
        .btn-secondary {
            background-color: var(--secondary-bg);
            color: var(--secondary-text);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--secondary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
        }
        .btn-success {
            background-color: var(--success-color) !important; /* !important para sobrescrever */
            color: #ffffff !important;
        }
        .btn-success:hover:not(:disabled) {
            background-color: var(--success-hover) !important;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        .btn-secondary .loading-spinner {
            border: 4px solid rgba(67, 56, 202, 0.2);
            border-left-color: var(--secondary-text);
        }
        .loading-spinner.hidden { display: none; }
        .button-text.hidden { display: none; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Icone de Conclus√£o */
        /* REMOVIDO: .completion-icon { ... } */
        /* REMOVIDO: .completion-icon.hidden { display: none; } */

        /* ========================================================== */
        /* ==================== UI MELHORADA ====================== */
        /* ========================================================== */
        .accordion-item {
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden; /* Garante que o conte√∫do escondido n√£o vaze */
            background-color: var(--bg-light);
        }
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            user-select: none; /* Impede sele√ß√£o de texto ao clicar */
        }
        /* Estilo para o cabe√ßalho do acorde√£o ativo */
        .accordion-header.active {
            background-color: var(--secondary-bg);
        }
        .dark .accordion-header.active {
            background-color: #374151; /* Gray-700 */
        }
        .header-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .header-buttons {
            display: flex;
            gap: 0.5rem; /* Espa√ßamento entre os bot√µes de a√ß√£o */
        }
        .accordion-header h3 {
            margin-bottom: 0; /* Remove a margem padr√£o do h3 */
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        .accordion-arrow {
            transition: transform 0.3s ease-in-out;
        }
        .accordion-arrow.open {
            transform: rotate(180deg);
        }
        .accordion-body {
            max-height: 0; /* Escondido por padr√£o */
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
            padding: 0 1.5rem; /* Padding vertical zero quando fechado */
        }
        /* For√ßa o fundo correto para o corpo do acorde√£o */
        .accordion-body {
            background-color: #ffffff; /* Fundo branco padr√£o (Modo Claro) */
        }
        /* Define a cor correta para o fundo do corpo no Modo Escuro */
        .dark .accordion-body {
            background-color: #1f2937; /* Mesmo fundo do container (Cinza 800) */
        }
        /* Garante a cor de texto correta para o conte√∫do gerado */
        .generated-content-wrapper {
            color: var(--text-dark); /* Garante texto escuro no modo claro */
            line-height: 1.6; /* Melhora a legibilidade */
        }
        .dark .generated-content-wrapper {
            color: #d1d5db; /* Garante texto claro no modo escuro (Gray-300) */
        }
        .accordion-body.open {
            max-height: 5000px; /* Valor grande para "abrir" */
            padding: 1rem 1.5rem 1.5rem; /* Padding quando aberto */
        }
        .accordion-body .generated-content-wrapper[contenteditable="true"] {
            outline: none;
            padding: 0.5rem;
            border-radius: 4px;
            transition: box-shadow 0.2s, background-color 0.2s;
        }
        .accordion-body .generated-content-wrapper[contenteditable="true"]:focus {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
            background-color: #eef2ff; /* Fundo levemente azulado ao editar */
        }

        /* Bot√µes de Copiar e Re-gerar dentro das se√ß√µes */
        .copy-btn, .regenerate-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            white-space: nowrap;
        }
        .copy-btn {
            background-color: var(--primary-color);
            color: #ffffff;
        }
        .copy-btn:hover {
            background-color: var(--primary-hover);
        }
        .regenerate-btn {
            background-color: var(--secondary-bg);
            color: var(--secondary-text);
        }
        .regenerate-btn:hover {
            background-color: var(--secondary-hover);
        }
        
        /* Se√ß√µes de Prompts e Trilha Sonora */
        .section-prompts, .section-soundtrack {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px dashed #d1d5db;
        }
        .btn-small {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
        .loading-spinner-small {
            border: 3px solid rgba(67, 56, 202, 0.2);
            border-left-color: var(--secondary-text);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        .individual-prompt-block {
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .prompt-time {
            font-size: 0.75rem;
            color: var(--primary-color);
            font-weight: 700;
        }
        .prompt-phrase {
            font-size: 0.875rem;
            color: var(--text-dark);
            font-weight: 700;
            line-height: 1.4;
        }
        .prompt-description-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-medium);
            margin-top: 0.5rem;
            border-top: 1px dashed var(--border-light);
            padding-top: 0.5rem;
        }
        .prompt-description-content {
            font-size: 0.9rem;
            color: var(--text-dark);
            line-height: 1.5;
        }
        pre {
            background-color: var(--bg-light);
            border-radius: 4px;
            padding: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-medium);
            overflow-x: auto; /* Para lidar com blocos de estilo longos */
            white-space: pre-wrap; /* Quebra linhas longas */
            word-break: break-all; /* Quebra palavras longas */
        }
        .soundtrack-list {
            list-style-type: disc;
            padding-left: 20px;
            font-size: 0.9rem;
            color: var(--text-dark);
        }
        .soundtrack-list li { margin-bottom: 0.5rem; }

        /* Separador para Thumbnails */
        .thumbnail-item-separator {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-light);
        }

        /* Toast Notification */
        #toastNotification {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7); color: #fff; padding: 10px 20px;
            border-radius: 8px; font-size: 0.9rem; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            z-index: 1001; white-space: nowrap;
        }
        #toastNotification.toast-visible { opacity: 1; visibility: visible; }

        /* Alerta Full-Screen */
        #fullScreenAlertOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center;
            align-items: center; z-index: 1000; visibility: hidden; opacity: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #fullScreenAlertOverlay.visible { visibility: visible; opacity: 1; }
        #fullScreenAlertBox {
            /* Removido background-color e border para usar .card-background */
            padding: 2.5rem; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); text-align: center; max-width: 500px;
            width: 90%; position: relative; transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        #fullScreenAlertOverlay.visible #fullScreenAlertBox { transform: translateY(0); }
        #fullScreenAlertBox p { font-size: 1.1rem; color: var(--text-dark); margin-bottom: 1.5rem; line-height: 1.6; }
        #fullScreenAlertBox button {
            background-color: var(--primary-color); color: #ffffff; padding: 0.75rem 1.5rem;
            border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; border: none;
        }
        #fullScreenAlertBox button:hover { background-color: var(--primary-hover); }

        /* ========================================================== */
        /* ================= BARRA FLUTUANTE ====================== */
        /* ========================================================== */
        .floating-action-bar {
            position: fixed; top: 0; left: 0; width: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 999; padding: 0.75rem 0;
            transform: translateY(-100%); opacity: 0; visibility: hidden;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .floating-action-bar.visible { transform: translateY(0); opacity: 1; visibility: visible; }
        .action-bar-content {
            max-width: 1024px; margin: 0 auto; padding: 0 2rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .action-bar-buttons-group {
            display: flex; align-items: center; gap: 0.75rem;
            width: 100%; /* Garante que o grupo ocupe o espa√ßo */
        }
        .action-bar-buttons-group.hidden { display: none; }
        .action-bar-buttons-group .action-bar-title {
            white-space: nowrap; /* Impede que o t√≠tulo quebre linha */
            font-weight: 600;
            color: var(--text-dark);
        }
        .action-bar-buttons-group .btn-container {
            display: flex; gap: 0.75rem; justify-content: flex-end; width: 100%;
        }
        .btn-container .btn {
            padding: 0.5rem 1rem; /* Um pouco menores */
            font-size: 0.875rem;
        }
        /* Corre√ß√£o para o espa√ßamento dos bot√µes clonados */
        .action-bar-buttons-group .btn-container .btn { margin-left: 0.75rem; }
        .action-bar-buttons-group .btn-container .btn:first-child { margin-left: 0; }

        /* ========================================================== */
        /* ======== ESTILOS PARA A BARRA DE PROGRESO ========= */
        /* ========================================================== */
        #progressBar {
            transition: width 0.5s ease-in-out; /* Anima√ß√£o suave do crescimento da barra */
            background-color: var(--success-color); /* Usa a nossa cor de sucesso verde! */
        }

        /* ========================================================== */
        /* ===== CORRE√á√ÉO DE COR DE TEXTO PARA MODO CLARO ===== */
        /* ========================================================== */
        /* REMOVIDO: body:not(.dark) #titlesThumbnailsSection .p-3 p { color: #374151; } */
        /* REMOVIDO: body:not(.dark) #titlesThumbnailsSection .font-semibold { color: #1f2937; } */

        /* ========================================================== */
        /* ==================== MODO ESCURO ======================= */
        /* ========================================================== */
        body.dark {
            /* background-color e color j√° definidos acima */
        }
        .dark .container, .dark .accordion-item {
            /* background-color j√° definido acima */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }
        .dark .accordion-item { border-color: #4b5563; }
        .dark .floating-action-bar { background-color: rgba(31, 41, 55, 0.9); }
        .dark .action-bar-title, .dark h3, .dark h4, .dark label, .dark p { /* color j√° definido acima */ }
        .dark .text-gray-500 { color: #9ca3af; }
        .dark .input-group label { /* color j√° definido acima */ }
        /* As regras para .dark .input-group input, select, textarea j√° est√£o no bloco definitivo acima */
        .dark .bg-indigo-50 { background-color: #374151 !important; }
        .dark .border-indigo-200 { border-color: #4b5563 !important; }
        .dark .text-indigo-800 { color: #a5b4fc !important; }
        .dark .bg-gray-50 { background-color: #374151 !important; }
        .dark .border-gray-200 { border-color: #4b5563 !important; }
        .dark .accordion-body .generated-content-wrapper[contenteditable="true"]:focus {
            background-color: #4b5563;
        }
        .dark .individual-prompt-block {
            /* background-color e border j√° definidos por .card-background */
        }
        .dark .prompt-phrase { color: #f3f4f6; }
        .dark .prompt-description-label { color: #9ca3af; }
        .dark .prompt-description-content { color: #d1d5db; }
        .dark pre { background-color: #374151 !important; color: #d1d5db; }
        .dark #darkModeToggle { color: #9ca3af; }

        /* Corre√ß√£o Espec√≠fica para Modo Escuro */
        /* Garante que o input do tema siga as regras */
        .dark #videoTheme.card-background {
            background-color: #374151 !important; 
            border-color: #4b5563 !important; 
        }
        /* Garante que o container dos bot√µes de gera√ß√£o siga as regras */
        .dark #scriptGenerationControls.card-background {
            background-color: #1f2937 !important; /* Cinza 800 */
            border-top: 1px solid #4b5563 !important; /* Adiciona uma borda superior para separar */
            border-left: none !important;
            border-right: none !important;
            border-bottom: none !important;
        }

        /* ========================================================== */
        /* ==================== ESTILOS TOOLTIP ===================== */
        /* ========================================================== */
        .tooltip {
            position: relative;
            cursor: help;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #e0e7ff; /* Indigo-100 */
            color: #4338ca; /* Indigo-700 */
            font-weight: bold;
            font-size: 0.8rem;
            /* Removido border para usar .card-background, mas manteremos o border-color para a borda espec√≠fica do tooltip */
            border-color: #c7d2fe;
        }
        .dark .tooltip {
            background-color: #4b5563; /* Gray-600 */
            color: #e5e7eb; /* Gray-200 */
            border-color: #374151; /* Gray-700 */
        }
        /* Esconde o tooltip por padr√£o */
        .tooltip::before, .tooltip::after {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            position: absolute;
            bottom: 150%; /* Posiciona acima do (?) */
            left: 50%;
            transform: translateX(-50%) translateY(10px); /* Come√ßa um pouco abaixo */
            z-index: 10;
        }
        /* Mostra o tooltip no hover */
        .tooltip:hover::before, .tooltip:hover::after {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(0); /* Sube para a posi√ß√£o final */
        }
        /* Estilo da caixa de texto do tooltip */
        .tooltip::before {
            content: attr(data-tooltip); /* Pega o texto do atributo! */
            background-color: #1f2937; /* Gray-800 */
            color: #f9fafb; /* Gray-50 */
            padding: 0.75rem;
            border-radius: 8px;
            width: 300px; /* Largura do tooltip */
            text-align: left;
            white-space: pre-wrap; /* Respeita as quebras de linha do atributo */
            font-size: 0.85rem;
            line-height: 1.5;
            font-weight: normal;
        }
        .dark .tooltip::before {
            background-color: #374151; /* Gray-700 */
        }
        /* Estilo da setinha do tooltip */
        .tooltip::after {
            content: '';
            border-width: 6px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent; /* Seta aponta para baixo */
            margin-left: -6px; /* Centraliza a seta */
        }
        .dark .tooltip::after {
            border-color: #374151 transparent transparent transparent;
        }
        .dark .section-prompts, .dark .section-soundtrack { border-top-color: #4b5563; }
        .dark .soundtrack-list { color: #d1d5db; }

        /* Anima√ß√£o para surgimento suave das se√ß√µes */
        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in {
            animation: fadeInSlideUp 0.5s ease-out forwards;
        }

        /* ========================================================== */
        /* ============ ESTILOS MODO FOCO - VERS√ÉO FINAL ============ */
        /* ========================================================== */
        /* Quando o modo foco est√° ativo... */
        /* 1. Esconde os elementos que n√£o queremos ver */
        body.zen-mode .floating-action-bar,
        body.zen-mode #mainInputsGrid,
        body.zen-mode #progressBarContainer,
        body.zen-mode #assetsColumn,
        body.zen-mode .absolute.top-4.right-4, /* Esconde os bot√µes do canto */
        body.zen-mode .container > h1,
        body.zen-mode .container > p {
            display: none !important;
        }

        /* 2. Ajusta o container e o grid principal */
        body.zen-mode .container {
            max-width: 100%;
            padding: 1rem;
        }

        body.zen-mode #projectDashboard .grid {
            display: block; /* Faz o grid se comportar como um bloco normal */
        }

        /* 3. Expande a coluna do roteiro para ocupar todo o espa√ßo */
        body.zen-mode #scriptColumn {
            max-height: none; 
            grid-column: auto; /* Reseta as regras de coluna do grid */
        }
        /* Mostra o bot√£o de sair apenas no Modo Foco */
        body.zen-mode #exitZenModeBtn {
            display: inline-flex;
        }
        
        /* ========================================================== */
        /* Estilos para a coluna de roteiro com controles fixos */
        /* ========================================================== */
        #scriptColumn {
            /* Define uma altura m√°xima para a coluna, para que a rolagem interna funcione */
            /* 'vh' √© a altura da viewport (tela vis√≠vel) */
            max-height: 90vh; 
        }
        #scriptSectionsContainer {
            /* Permite que este cont√™iner de acorde√µes ocupe todo o espa√ßo dispon√≠vel e role */
            flex-grow: 1;
            overflow-y: auto;
        }
        /* ========================================================== */
        /* ====== PAINEL DE BOT√ïES STICKY - DESIGN FINAL ELEGANTE ===== */
        /* ========================================================== */
        #scriptGenerationControls {
            position: sticky;
            bottom: 0;
            z-index: 10;
            padding: 1rem 1.5rem; /* Espa√ßamento interno consistente */

            /* MANTIDO: O efeito de vidro fosco */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);

            /* ADICIONADO: Sombra sutil para o efeito flutuante */
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.08);

            /* Garante que o painel ocupe a largura da coluna e tenha as bordas inferiores arredondadas */
            border-bottom-left-radius: 0.5rem; /* 8px */
            border-bottom-right-radius: 0.5rem; /* 8px */
            
            /* --- Estilos para MODO CLARO --- */
            background-color: rgba(255, 255, 255, 0.75); /* Fundo branco com mais transpar√™ncia */
            border-top: 1px solid rgba(0, 0, 0, 0.07); /* Borda superior muito sutil */
        }
        
        .dark #scriptGenerationControls {
            /* --- Estilos para MODO ESCURO --- */
            background-color: rgba(31, 41, 55, 0.75); /* Fundo cinza-800 com mais transpar√™ncia */
            border-top-color: rgba(255, 255, 255, 0.1); /* Borda superior clara e sutil */
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.2); /* Sombra um pouco mais forte para o modo escuro */
        }

        /* Ajuste fino no t√≠tulo "Gerar Se√ß√µes do Roteiro" dentro do painel */
        #scriptGenerationControls h3 {
            color: var(--text-dark) !important;
        }
        .dark #scriptGenerationControls h3 {
            color: #f3f4f6 !important;
        }

        /* ========================================================== */
        /* =============== ESTILOS DE IMPRESS√ÉO (PDF) =============== */
        /* ========================================================== */
        @media print {
            /* Esconde tudo que n√£o est√° no nosso container de impress√£o */
            body > *:not(#print-container) {
                display: none !important;
            }

            /* Regras para o container de impress√£o */
            #print-container, #print-container * {
                visibility: visible; /* Garante que ele e TODOS os seus filhos sejam vis√≠veis */
                color: #000 !important; /* FOR√áA tudo dentro dele a ser preto */
                background-color: #fff !important; /* Garante fundo branco */
            }

            #print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 1.5cm; /* Margens de documento */
                font-size: 11pt;
            }

            .print-section-title {
                font-size: 16pt;
                font-weight: bold;
                margin-top: 24px;
                margin-bottom: 12px;
                border-bottom: 1px solid #ccc;
                padding-bottom: 4px;
            }

            .print-section-content {
                line-height: 1.6;
                white-space: pre-wrap; /* Respeita as quebras de linha */
            }
        }

        /* ========================================================== */
        /* ========= CORRE√á√ïES FINAIS PARA MODO ESCURO ========== */
        /* ========================================================== */
        /* Garante que o input focado no modo escuro tenha o fundo correto */
        .dark .input-group input:focus {
            background-color: #4b5563 !important; /* gray-600 */
        }
        /* Garante que os blocos de prompt individuais fiquem escuros */
        .dark .individual-prompt-block {
            background-color: #1f2937 !important; /* gray-800 */
            border-color: #4b5563 !important; /* gray-600 */
        }
        /* Garante que o texto dentro dos prompts fique claro */
        .dark .prompt-phrase,
        .dark .prompt-description-content {
            color: #d1d5db !important; /* gray-300 */
        }
        /* Garante que o fundo do <pre> tamb√©m fique escuro */
        .dark .individual-prompt-block pre {
            background-color: #374151 !important; /* gray-700 */
        }

        /* ========================================================== */
        /* ========= CORRE√á√ïES FINAIS PARA MODO CLARO ========== */
        /* ========================================================== */
        /* Define a cor padr√£o (Modo Claro) para os t√≠tulos do dashboard */
        #projectDashboard h2,
        #projectDashboard h3 {
            color: var(--text-dark) !important;
        }
        /* Define a cor para o Modo Escuro, garantindo que ela sobrescreva o padr√£o */
        .dark #projectDashboard h2,
        .dark #projectDashboard h3 {
            color: #f3f4f6 !important; /* Cor de texto clara */
        }

        /* ========================================================== */
        /* ========= BLINDAGEM DE ESTILO PARA PROMPTS ========== */
        /* ========================================================== */
        /* Estilo para o <pre> em MODO CLARO dentro do prompt */
        .individual-prompt-block pre {
            background-color: var(--bg-light) !important; /* Ex: #f9fafb (cinza 50) */
            color: var(--text-medium) !important; /* Ex: #4b5563 (cinza 600) */
        }
        /* Estilo para o <pre> em MODO ESCURO dentro do prompt */
        .dark .individual-prompt-block pre {
            background-color: #374151 !important; /* Cinza 700 */
            color: #d1d5db !important; /* Cinza 300 */
        }

        /* ========================================================== */
        /* ==== BLINDAGEM FINAL DE TEXTOS PARA O PAINEL (AMBAS COLUNAS) - CORRIGIDO ==== */
        /* ========================================================== */
        /* Define a cor de texto padr√£o (MODO CLARO) para o conte√∫do dos pain√©is */
        /* MODIFICADO: Adicionamos os IDs dos containers de conte√∫do gerado */
        #projectDashboard #videoDescriptionContent,
        #projectDashboard #titlesThumbnailsContent,
        #projectDashboard .card-background p,
        #projectDashboard #projectDashboard .card-background li, /* Added specific rule for li inside card-background */
        #projectDashboard .card-background strong,
        #projectDashboard .asset-card-placeholder,
        #projectDashboard .list-disc {
            color: var(--text-dark) !important;
        }

        /* Define a cor de texto (MODO ESCURO) para o conte√∫do dos pain√©is */
        /* MODIFICADO: Adicionamos os IDs dos containers de conte√∫do gerado */
        .dark #projectDashboard #videoDescriptionContent,
        .dark #projectDashboard #titlesThumbnailsContent,
        .dark #projectDashboard .card-background p,
        .dark #projectDashboard .card-background li, /* Added specific rule for li inside card-background */
        .dark #projectDashboard .card-background strong,
        .dark #projectDashboard .asset-card-placeholder,
        .dark #projectDashboard .list-disc {
            color: #d1d5db !important;
        }

        /* Ajuste espec√≠fico para os t√≠tulos H3 e H4 dentro do painel */
        #projectDashboard h3, #projectDashboard h4 {
            color: var(--text-dark) !important;
        }
        .dark #projectDashboard h3, .dark #projectDashboard h4 {
            color: #f3f4f6 !important;
        }
        /* ========================================================== */
        /* === CORRE√á√ÉO FINAL - FUNDO DO ACORDE√ÉO NO MODO ESCURO ==== */
        /* ========================================================== */
        /* Esta regra garante que o item do acorde√£o (e por heran√ßa, seu
           cabe√ßalho inativo) tenha o fundo escuro correto no Modo Escuro,
           sobrescrevendo a regra geral do modo claro. */
        .dark .accordion-item {
            background-color: #1f2937; /* Cinza 800 - o mesmo do container */
        }
        /* ========================================================== */
        /* === ESTILOS PARA ACORDE√ÉO ANINHADO (PROMPTS E TRILHA) ==== */
        /* ========================================================== */
        .nested-accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-top: 1.5rem;
            padding: 0.75rem 1rem; /* Ajustado para um padding mais compacto */
            border-top: 1px dashed var(--border-light);
            transition: background-color 0.2s;
            border-radius: 6px;
        }

        .dark .nested-accordion-header {
            border-top-color: #4b5563;
        }
        
        .nested-accordion-header:hover, .nested-accordion-header.active {
            background-color: var(--bg-light);
        }

        .dark .nested-accordion-header:hover, .dark .nested-accordion-header.active {
             background-color: #374151; /* Gray-700 */
        }

        .nested-accordion-header h4 {
            font-size: 1rem;
            font-weight: 700;
            margin: 0;
            color: var(--text-medium);
        }
        
        .dark .nested-accordion-header h4 {
            color: #9ca3af;
        }

        /* ========================================================== */
        /* ================ ESTILO DO BOT√ÉO "OUVIR" ================= */
        /* ========================================================== */
        .listen-btn {
            background-color: transparent;
            color: var(--text-medium);
            border: 1px solid var(--border-light);
            padding: 0.4rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dark .listen-btn {
            color: #9ca3af;
            border-color: #4b5563;
        }
        .listen-btn:hover {
            background-color: var(--bg-light);
        }
        .dark .listen-btn:hover {
            background-color: #374151;
        }
        .listen-btn svg.animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <!-- ========================================================== -->
    <!-- ===== BARRA FLUTUANTE COM BOT√ïES INDEPENDENTES ===== -->
    <!-- ========================================================== -->
    <div id="floatingActionBar" class="floating-action-bar">
        <div class="action-bar-content">
            <!-- Grupo de A√ß√µes Principais -->
            <div id="mainActions" class="action-bar-buttons-group">
                <span class="action-bar-title">Passo 1:</span>
                <div class="btn-container">
                    <button id="float_generateIntroBtn" class="btn btn-primary">Introdu√ß√£o</button>
                    <button id="float_generateDevelopmentBtn" class="btn btn-primary">Desenvolvimento</button>
                    <button id="float_climaxBtn" class="btn btn-primary">Cl√≠max</button>
                    <button id="float_conclusionBtn" class="btn btn-primary">Conclus√£o</button>
                    <button id="float_generateCTABtn" class="btn btn-primary">CTA</button>
                </div>
            </div>
            <!-- Grupo de A√ß√µes R√°pidas -->
            <div id="quickActions" class="action-bar-buttons-group hidden">
                <span class="action-bar-title">A√ß√µes R√°pidas:</span>
                 <div class="btn-container">
                    <button id="float_generateDescriptionBtn" class="btn btn-secondary">Descri√ß√£o</button>
                    <button id="float_generateTitlesAndThumbnailsBtn" class="btn btn-secondary">T√≠tulos</button>
                    <button id="float_downloadPdfBtn" class="btn btn-secondary">PDF</button>
                    <button id="float_resetScriptBtn" class="btn btn-secondary">Novo</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container relative">
        <div class="absolute top-4 right-4 flex items-center gap-2 z-[1001]">
            <button id="toggleZenModeBtn" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-gray-500 dark:text-gray-400" title="Modo Foco">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/><path d="M3 14.5a1.5 1.5 0 0 1-1.5-1.5V3a1.5 1.5 0 0 1 1.5-1.5h10A1.5 1.5 0 0 1 14.5 3v10a1.5 1.5 0 0 1-1.5 1.5H3zM4 3v10h8V3H4z"/></svg>
            </button>
            <button id="darkModeToggle" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-gray-500 dark:text-gray-400" title="Modo Escuro">
                <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-14.66l-.707.707M4.04 19.96l-.707.707M21 12h-1M4 12H3m16.66-7.96l-.707-.707M4.04 4.04l-.707-.707m11.314 0l-1.414 1.414M5.464 18.536l-1.414 1.414m12.728-1.414l-1.414-1.414m-9.9-9.9l-1.414-1.414M12 6a6 6 0 100 12 6 6 0 000-12z" /></svg>
            </button>
        </div>
        
        <h1 class="text-4xl font-extrabold text-gray-800 dark:text-gray-100 text-center mb-2">Gerador de Roteiros Virais v2.0</h1>
        <p class="text-center text-gray-500 dark:text-gray-400 mb-8">O seu painel de controle para conte√∫do de alto impacto.</p>
        
        <!-- Se√ß√£o de Inputs da Aplica√ß√£o -->
        <div id="mainInputsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="input-group">
                <label for="channelName">Nome do Canal:</label>
                <input type="text" id="channelName" class="card-background" placeholder="Ex: The Biblical Unveiling" value="The Biblical Unveiling">
            </div>
            <div class="input-group">
                <label for="videoTheme">Tema do V√≠deo:</label>
                <input type="text" id="videoTheme" class="card-background" placeholder="Ex: A Arca da Alian√ßa Foi Encontrada?">
            </div>
             <div class="input-group md:col-span-2">
                <label for="videoDescription">Descri√ß√£o do V√≠deo (para inspira√ß√£o):</label>
                <textarea id="videoDescription" rows="4" class="card-background" placeholder="Cole uma breve descri√ß√£o do v√≠deo aqui para que a IA possa usar como inspira√ß√£o para o roteiro."></textarea>
            </div>

            <!-- Bot√£o de Estrat√©gia Autom√°tica com IA -->
            <div class="md:col-span-2 my-4 flex justify-center">
                <button id="analyzeStrategyBtn" class="btn btn-primary w-full md:w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 2.672a.5.5 0 1 0 1 0V.843a.5.5 0 0 0-1 0v1.829Zm4.5.035A.5.5 0 0 0 13.293 2L12 3.293a.5.5 0 1 0 .707.707L14 2.707a.5.5 0 0 0 0-.707ZM7.293 4A.5.5 0 1 0 8 3.293L6.707 2A.5.5 0 0 0 6 2.707L7.293 4Zm-.621 2.5a.5.5 0 0 0 0 .707l1.293 1.293a.5.5 0 0 0 .707-.707L7.38 6.207a.5.5 0 0 0-.707 0ZM5.5 7a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1Zm-1.829-1.5a.5.5 0 0 0-.707 0L2 6.793a.5.5 0 0 0 0 .707l1.293 1.293a.5.5 0 0 0 .707-.707L3.707 7.5H3.5a.5.5 0 0 0 0-1h.207L2.707 5.5Zm-1 .707a.5.5 0 0 0-.707-.707L.707 6.5a.5.5 0 0 0 0 .707l1.293 1.293a.5.5 0 0 0 .707-.707L1.293 7.5H1.5a.5.5 0 0 0 0-1h-.207L2.293 6.207Z"/><path d="M12.026 8.5H11a.5.5 0 0 0 0 1h1.026a.5.5 0 0 0 0-1Zm-1.633.293a.5.5 0 1 1 .707.707l-1.293 1.293a.5.5 0 0 1-.707-.707l1.293-1.293Zm-3.134 3.367a.5.5 0 1 0-.707.707l1.293 1.293a.5.5 0 0 0 .707-.707l-1.293-1.293Zm1.633-.293a.5.5 0 1 1 .707.707l-1.293 1.293a.5.5 0 0 1-.707-.707l1.293-1.293A.5.5 0 0 1 8.89 11.86Z"/></svg>
                    <span class="button-text">Definir Estrat√©gia com IA</span>
                    <div class="loading-spinner hidden"></div>
                </button>
            </div>
            
            <!-- Campos de Estrat√©gia Preenchidos pela IA -->
            <div class="input-group md:col-span-2">
                <label for="targetAudience">P√∫blico-Alvo:</label>
                <input type="text" id="targetAudience" class="card-background" value="Pessoas Interessadas em Arqueologia B√≠blica e Hist√≥ria Antiga, Crist√£os e Pessoas de F√©, Entusiastas de Ci√™ncia e Ceticismo (com mente aberta), Curiosos em Geral e Amantes de Mist√©rios." readonly>
            </div>
            <div class="input-group">
                <label for="languageSelect">Idioma do Roteiro:</label>
                <select id="languageSelect" class="card-background">
                    <option value="pt-br">Portugu√™s (Brasil)</option>
                    <option value="pt-pt">Portugu√™s (Portugal)</option>
                    <option value="en" selected>English</option>
                    <option value="es">Espa√±√£o</option>
                </select>
            </div>
            <div class="input-group">
                <label for="languageStyle">Estilo de Linguagem:</label>
                <select id="languageStyle" class="card-background">
                    <option value="formal">Formal</option>
                    <option value="informal">Informar</option>
                    <option value="emocional">Emocional</option>
                    <option value="tecnico">T√©cnico</option>
                    <option value="inspirador" selected>Inspirador</option>
                    <option value="humoristico">Humor√≠stico</option>
                </select>
            </div>
            <div class="input-group md:col-span-2">
                <label for="videoObjective">Objetivo do V√≠deo:</label>
                <select id="videoObjective" class="card-background">
                    <option value="informar" selected>Informar</option>
                    <option value="emocionar">Emocionar</option>
                    <option value="evangelizar">Evangelizar (criar defensores)</option>
                    <option value="vender">Vender</option>
                    <option value="entreter">Entreter</option>
                </select>
            </div>
            <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <div class="input-group">
                    <label for="videoDuration">Dura√ß√£o Desejada:</label>
                    <select id="videoDuration" class="card-background">
                        <option value="">-- Selecione a Dura√ß√£o --</option>
                        <option value="short">Curto (~1-3 min)</option>
                        <option value="medium">M√©dio (~4-7 min)</option>
                        <option value="long">Longo (~8-12 min)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="speakingPace">Ritmo de Fala:</label>
                    <select id="speakingPace" class="card-background">
                        <option value="moderate" selected>Moderado</option>
                        <option value="slow">Lento</m>
                        <option value="fast">R√°pido</option>
                    </select>
                </div>
            </div>
            <!-- NOVO M√ìDULO DE SELE√á√ÉO DE NARRATIVA - INSERIR ESTE BLOCO -->
            <div class="input-group md:col-span-1">
                <label for="narrativeGoal">1. Objetivo da Narrativa:</label>
                <select id="narrativeGoal" class="card-background">
                    <option value="storytelling">Conectar e Entreter (Storytelling)</option>
                    <option value="storyselling">Persuadir e Vender (Storyselling)</option>
                </select>
            </div>
            <div class="input-group md:col-span-1">
                <div class="flex items-center gap-2">
                    <label for="narrativeStructure">2. Estrutura Espec√≠fica:</label>
                    <span id="narrativeStructureTooltip" class="tooltip card-background" data-tooltip="Selecione um objetivo primeiro.">
                        (?)
                    </span>
                </div>
                <select id="narrativeStructure" class="card-background">
                    <!-- As op√ß√µes ser√£o preenchidas dinamicamente pelo JavaScript -->
                </select>
            </div>
            <!-- ========================================================== -->
            <!-- === NOVO M√ìDULO: PERSONALIDADE DA NARRATIVA (TEMA/TOM/VOZ) === -->
            <!-- ========================================================== -->
            <div class="input-group md:col-span-2">
                <label for="narrativeTheme">3. Tema Principal (a grande ideia):</label>
                <input type="text" id="narrativeTheme" class="card-background" placeholder="Ex: Supera√ß√£o, Luta contra injusti√ßa, Inova√ß√£o, A busca pela verdade...">
            </div>
            <div class="input-group md:col-span-1">
                <label for="narrativeTone">4. Tom da Narra√ß√£o (a sensa√ß√£o):</label>
                <select id="narrativeTone" class="card-background">
                    <option value="inspirador" selected>Inspirador / Motivacional</option>
                    <option value="serio">S√©rio / Factual</option>
                    <option value="emocional">Emocional / Vulner√°vel</option>
                    <option value="humoristico">Humor√≠stico / Leve</option>
                    <option value="desafiador">Desafiador / Provocativo</option>
                    <option value="sombrio">Sombrio / Misterioso</option>
                </select>
            </div>
            <div class="input-group md:col-span-1">
                <label for="narrativeVoice">5. Voz do Narrador (a personalidade):</label>
                <input type="text" id="narrativeVoice" class="card-background" placeholder="Ex: S√°bio e experiente, Jovem e c√©tico, Apaixonado e en√©rgico...">
            </div>
            
            <div class="input-group md:col-span-2">
                <label for="centralQuestion">Pergunta Central (Opcional):</label>
                <textarea id="centralQuestion" rows="2" class="card-background" placeholder="Ex: A Arca da Alian√ßa Foi Encontrada?"></textarea>
            </div>
            <div class="input-group md:col-span-2">
                <label for="emotionalArc">Arco Emocional Desejado (Opcional):</label>
                <textarea id="emotionalArc" rows="2" class="card-background" placeholder="Ex: Come√ßar com curiosidade, construir para admira√ß√£o, e terminar com inspira√ß√£o."></textarea>
            </div>
            <!-- REMOVIDO: Elementos Virais/Tend√™ncias (Opcional) -->
            <div class="input-group md:col-span-2">
                <label for="imageDescriptionEngine">Motor de Descri√ß√£o de Imagem:</label>
                <textarea id="imageDescriptionEngine" rows="2" class="card-background" placeholder="Ex: 'alta resolu√ß√£o', 'detalhado', 'fotorrealista', 'cores vibrantes'"></textarea>
            </div>
            <div class="input-group md:col-span-2">
                <label for="imageStyleSelect">Motor de Qualidade de Imagem:</label>
                <select id="imageStyleSelect" class="card-background">
                    <option value="cinematic" selected>Cinematogr√°fico</option>
                    <option value="custom">Personalizado</option>
                    <option value="none">Nenhum</option>
                </select>
            </div>
            <div class="input-group md:col-span-2" id="customImageStyleContainer" style="display: none;">
                <label for="customImageStyle">Estilo Visual Personalizado:</label>
                <textarea id="customImageStyle" rows="5" class="card-background" placeholder="Cole aqui o seu bloco de estilo personalizado (ex: para cartoon, anime, etc.)."></textarea>
            </div>
        </div>

        <!-- ========================================================== -->
        <!-- ========= NOVA BARRA DE PROGRESO VISUAL ============= -->
        <!-- ========================================================== -->
        <div id="progressBarContainer" class="progress-bar-container mb-8">
            <div class="flex justify-between mb-1">
                <span class="text-base font-medium text-gray-700 dark:text-gray-300">Progresso do Projeto</span>
                <span id="progressText" class="text-sm font-medium text-gray-700 dark:text-gray-300">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>
        <!-- ========================================================== -->
       
        <!-- ========================================================== -->
        <!-- ===== NOVA √ÅREA DE SA√çDA: O PAINEL DO PROJETO ======== -->
        <!-- ========================================================== -->
        <div id="projectDashboard" class="hidden mt-12">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- Coluna Principal: Roteiro -->
                <div id="scriptColumn" class="lg:col-span-7 flex flex-col gap-4">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 border-b-2 border-indigo-200 dark:border-indigo-800 pb-2">Roteiro Principal</h2>

                    <!-- Cart√£o do Esbo√ßo Estrat√©gico (permanece no topo) -->
                    <div id="strategicOutlineCard" class="card-background p-4 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200">Esbo√ßo Estrat√©gico</h3>
                            <button id="generateOutlineBtn" class="btn btn-secondary btn-small">Criar Esbo√ßo</button>
                        </div>
                        <div id="outlineContent">
                             <div class="asset-card-placeholder">Clique em 'Criar Esbo√ßo' para a IA planear a estrutura do roteiro.</div>
                        </div>
                    </div>

                    <!-- Novo Cont√™iner para os Acorde√µes que vai rolar -->
                    <div id="scriptSectionsContainer" class="flex-grow space-y-4 overflow-y-auto">
                        <div id="introSection" class="script-section"></div>
                        <div id="developmentSection" class="script-section"></div>
                        <div id="climaxSection" class="script-section"></div>
                        <div id="conclusionSection" class="script-section"></div>
                        <div id="ctaSection" class="script-section"></div>
                    </div>
                    
                    <!-- Controles de Gera√ß√£o, agora fixos no final da coluna -->
                    <div id="scriptGenerationControls" class="rounded-b-lg sticky bottom-0">
                        <h3 class="font-bold text-lg text-indigo-800 dark:text-indigo-300 mb-3 text-center">Gerar Sec√ß√µes do Roteiro</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            <button id="generateIntroBtn" class="btn btn-primary btn-small">Introdu√ß√£o</button>
                            <button id="generateDevelopmentBtn" class="btn btn-primary btn-small">Desenvolvimento</button>
                            <button id="climaxBtn" class="btn btn-primary btn-small">Cl√≠max</button>
                            <button id="conclusionBtn" class="btn btn-primary btn-small">Conclus√£o</button>
                            <button id="generateCTABtn" class="btn btn-primary btn-small">CTA</button>
                        </div>
                    </div>
                </div>

                <!-- Coluna Lateral: Recursos e Metadados -->
                <div id="assetsColumn" class="lg:col-span-5 space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 border-b-2 border-indigo-200 dark:border-indigo-800 pb-2">Recursos</h2>
                    
                    <!-- Cart√£o: Descri√ß√£o e Hashtags (AGORA PRIMEIRO) -->
                    <div class="card-background p-4 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200">Descri√ß√£o & Hashtags</h3>
                            <button id="generateDescriptionBtn" class="btn btn-secondary btn-small">Gerar</button>
                        </div>
                        <div id="videoDescriptionContent">
                             <div class="asset-card-placeholder">Clique em 'Gerar' para ver a descri√ß√£o</div>
                        </div>
                    </div>

                    <!-- Cart√£o: T√≠tulos e Thumbnails (AGORA EM SEGUNDO) -->
                    <div class="card-background p-4 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200">T√≠tulos & Thumbnails</h3>
                            <button id="generateTitlesAndThumbnailsBtn" class="btn btn-secondary btn-small">Gerar</button>
                        </div>
                        <div id="titlesThumbnailsContent">
                             <div class="asset-card-placeholder">Clique em 'Gerar' para ver as sugest√µes</div>
                        </div>
                    </div>

                    <!-- Cart√£o: Storyboard Visual (REMOVIDO) -->
                    <div id="storyboardContent" style="display: none;"></div>
                    
                    <!-- Cart√£o: Salvar e Exportar -->
                    <div class="card-background p-4 rounded-lg shadow-md">
                         <h3 class="font-bold text-lg text-gray-800 dark:text-gray-200 mb-3">Finalizar Projeto</h3>
                         <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            <button id="exportProjectBtn" class="btn btn-secondary">Exportar</button>
                            <button id="importProjectBtn" class="btn btn-secondary">Importar</button>
                            <input type="file" id="importFileInput" class="hidden" accept=".json">
                            <button id="downloadPdfBtn" class="btn btn-secondary">PDF</button>
                            <button id="resetScriptBtn" class="btn btn-secondary">Novo</button>
                            <!-- BOT√ÉO NOVO ADICIONADO AQUI -->
                            <button id="copyTranscriptBtn" class="btn btn-secondary col-span-2 sm:col-span-1">Copiar Transcri√ß√£o</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√£o para Sair do Modo Foco (come√ßa escondido) -->
    <button id="exitZenModeBtn" class="hidden fixed top-5 right-5 z-[2001] bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm p-2 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/><path d="M3 14.5a1.5 1.5 0 0 1-1.5-1.5V3a1.5 1.5 0 0 1 1.5-1.5h10A1.5 1.5 0 0 1 14.5 3v10a1.5 1.5 0 0 1-1.5 1.5H3zM4 3v10h8V3H4z"/></svg>
            </button>
    
    <!-- Elementos de Feedback (Toast e Alerta) -->
    <div id="toastNotification" class="toast-notification"></div>
    <div id="fullScreenAlertOverlay">
        <div id="fullScreenAlertBox" class="card-background">
            <p id="fullScreenAlertMessage"></p>
            <button id="fullScreenAlertCloseBtn">Entendi</button>
        </div>
    </div>

    <!-- Player de √Åudio Global para Pr√©-visualiza√ß√£o -->
    <audio id="audioPlayer" style="display: none;"></audio>
    
    <script type="module">
        // ==========================================================
        // ==================== SETUP INICIAL =======================
        // ==========================================================
        // Vari√°veis de estado globais
        let generatedTitlesAndThumbnails = null;
        let allImagePrompts = {}; 
        let strategicOutline = null;
        let totalScriptSeconds = 0; 
    
        // Bloco de estilo cinematogr√°fico para prompts de imagem
        const CINEMATIC_STYLE_BLOCK = `
**[ESTILO CINEMATOGR√ÅFICO]**
Ultra-realistic, high-resolution photographic image. Captured with natural lighting and cinematic composition. Rich textures and fine surface details ‚Äî visible skin pores, fabric fibers, weathered materials, realistic reflections, and organic imperfections. Sharp focus with subtle depth of field. True-to-life colors with refined tonal range. Every element should look authentic, physical, and believable ‚Äî as if taken with a high-end DSLR camera. No exaggerated features, no artificial smoothness ‚Äî only pure, grounded realism.`;
        // Labels para descri√ß√£o de imagem em diferentes idiomas
        const imageDescriptionLabels = { 'pt-br': 'Descri√ß√£o da Imagem:', 'pt-pt': 'Descri√ß√£o da Imagem:', 'en': 'Image Description:' };

        // Mapeamento de elementos do DOM para acesso f√°cil
        const elements = {};
        const buttons = {};
        // Mapeia todos os elementos e bot√µes com ID
        document.querySelectorAll('[id]').forEach(el => {
            if (el.tagName === 'BUTTON') {
                buttons[el.id] = el;
            } else {
                elements[el.id] = el;
            }
        });

        // ==========================================================
        // ================== FUN√á√ïES DE UTILIDADE ==================
        // ==========================================================
        /**
         * Exibe uma notifica√ß√£o toast na parte inferior da tela.
         * @param {string} message - A mensagem a ser exibida.
         */
        window.showToast = (message) => {
            elements.toastNotification.textContent = message;
            elements.toastNotification.classList.add('toast-visible');
            setTimeout(() => {
                elements.toastNotification.classList.remove('toast-visible');
                setTimeout(() => { elements.toastNotification.textContent = ''; }, 300);
            }, 3000);
        };

        /**
         * Copia um texto para a √°rea de transfer√™ncia.
         * @param {string} text - O texto a ser copiado.
         */
        window.copyTextToClipboard = async (text) => {
            try {
                await navigator.clipboard.writeText(text);
                window.showToast('Copiado!');
            } catch (err) {
                // Fallback para navegadores mais antigos ou contextos restritos (ex: iframes)
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                try {
                    document.execCommand('copy');
                    window.showToast('Copiado!');
                } finally {
                    document.body.removeChild(ta);
                }
            }
        };

        /**
         * Fornece feedback visual em um bot√£o ap√≥s uma a√ß√£o de c√≥pia.
         * @param {HTMLElement} buttonElement - O elemento do bot√£o que foi clicado.
         */
        window.showCopyFeedback = (buttonElement) => {
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = 'Copiado!';
            buttonElement.classList.add('btn-success');
            buttonElement.disabled = true; // Desabilita o bot√£o temporariamente

            setTimeout(() => {
                buttonElement.innerHTML = originalText;
                buttonElement.classList.remove('btn-success');
                buttonElement.disabled = false;
            }, 2000); // Reverte ap√≥s 2 segundos
        };

        /**
         * Mostra um spinner de carregamento e desabilita todos os bot√µes de gera√ß√£o.
         * @param {HTMLElement} button - O bot√£o que acionou o carregamento.
         */
        const showLoading = (button) => {
            // Desabilitar TODOS os bot√µes de gera√ß√£o para evitar rate limit
            Object.values(buttons).forEach(btn => { if(btn) btn.disabled = true; });
        
            const textSpan = button.querySelector('.button-text');
            const spinnerDiv = button.querySelector('.loading-spinner');

            if (textSpan) textSpan.classList.add('hidden');
            if (spinnerDiv) spinnerDiv.classList.remove('hidden');
        };

        /**
         * Esconde o spinner de carregamento e reabilita os bot√µes.
         * @param {HTMLElement} button - O bot√£o que estava em estado de carregamento.
         */
        const hideLoading = (button) => {
            // Habilita TODOS os bot√µes de gera√ß√£o novamente
            Object.values(buttons).forEach(btn => { if(btn) btn.disabled = false; });
            
            const spinnerDiv = button.querySelector('.loading-spinner');
            if (spinnerDiv) spinnerDiv.classList.add('hidden');
            
            const textSpan = button.querySelector('.button-text');
            if (textSpan) textSpan.classList.remove('hidden');

            updateButtonStates(); // Chama a fun√ß√£o centralizada para reavaliar o estado
        };

        /**
         * Marca um bot√£o (original e flutuante) como conclu√≠do (cor verde).
         * @param {string} originalId - O ID do bot√£o original.
         */
        const markButtonAsCompleted = (originalId) => {
            const originalButton = document.getElementById(originalId);
            const floatButton = document.getElementById(`float_${originalId}`);

            [originalButton, floatButton].forEach(btn => {
                if (btn) {
                    btn.classList.remove('btn-primary', 'btn-secondary');
                    btn.classList.add('btn-success');
                }
            });
            updateProgressBar(); 
        };

        /**
         * Reseta os √≠cones de conclus√£o de todos os bot√µes (original e flutuante) para suas cores padr√£o.
         */
        const resetCompletionIcons = () => {
            const passo1_buttons_ids = ['generateIntroBtn', 'generateDevelopmentBtn', 'climaxBtn', 'conclusionBtn', 'generateCTABtn'];
            
            for (const buttonId in buttons) { // Iterar sobre todos os bot√µes
                const isPasso1 = passo1_buttons_ids.includes(buttonId);
                const originalButton = document.getElementById(buttonId);
                const floatButton = document.getElementById(`float_${buttonId}`);

                // Remove a classe de sucesso e adiciona a classe correta (primary/secondary)
                [originalButton, floatButton].forEach(btn => {
                    if (btn) {
                        btn.classList.remove('btn-success');
                        if (isPasso1) {
                            btn.classList.remove('btn-secondary');
                            btn.classList.add('btn-primary');
                        } else {
                            btn.classList.remove('btn-primary');
                            btn.classList.add('btn-secondary');
                        }
                    }
                });
            }
        };
        
        /**
         * Verifica se as se√ß√µes principais do roteiro foram geradas.
         * @returns {boolean} True se todas as se√ß√µes principais foram geradas, caso contr√°rio, false.
         */
        const isScriptComplete = () => {
            return ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection', 'ctaSection'].every(id => {
                const section = document.getElementById(id);
                return section && !section.classList.contains('hidden') && section.querySelector('.generated-content-wrapper')?.textContent.trim() !== '';
            });
        };

        /**
         * Atualiza o estado de habilita√ß√£o/desabilita√ß√£o dos bot√µes com base no estado do roteiro.
         */
        const updateButtonStates = () => {
            const allMainScriptGenerated = isScriptComplete();
            // Verifica se h√° qualquer conte√∫do gerado para habilitar PDF e reset
            const hasAnyContent = document.querySelector('#scriptColumn .accordion-item') != null; 

            // Bot√µes que dependem da conclus√£o do roteiro principal
            ['generateDescriptionBtn', 'generateTitlesAndThumbnailsBtn'].forEach(id => { 
                const originalBtn = document.getElementById(id);
                const floatBtn = document.getElementById(`float_${id}`);
                if (originalBtn) originalBtn.disabled = !allMainScriptGenerated;
                if (floatBtn) floatBtn.disabled = !allMainScriptGenerated;
            });
            
            // Bot√£o de reset sempre habilitado (ou desabilitado apenas se n√£o houver nada para resetar)
            const resetBtn = document.getElementById('resetScriptBtn');
            const floatResetBtn = document.getElementById('float_resetScriptBtn');
            if (resetBtn) resetBtn.disabled = false; 
            if (floatResetBtn) floatResetBtn.disabled = false;

        };

        /**
         * Mostra um alerta em tela cheia com uma mensagem.
         * @param {string} message - A mensagem a ser exibida.
         */
        const showFullScreenAlert = (message) => {
            elements.fullScreenAlertMessage.textContent = message;
            elements.fullScreenAlertOverlay.classList.add('visible');
        };

        /** Esconde o alerta em tela cheia. */
        const hideFullScreenAlert = () => {
            elements.fullScreenAlertOverlay.classList.remove('visible');
        };

        /** Alterna a visibilidade do campo de estilo de imagem personalizado. */
        const toggleCustomImageStyleVisibility = () => {
            elements.customImageStyleContainer.style.display = elements.imageStyleSelect.value === 'custom' ? 'block' : 'none';
        };

        /**
         * Coleta e concatena o texto puro de todas as se√ß√µes do roteiro na ordem correta.
         * @returns {string} A transcri√ß√£o completa e limpa.
         */
        const getTranscriptOnly = () => {
            let transcript = '';
            const sectionOrder = ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection', 'ctaSection'];
            
            sectionOrder.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                const contentWrapper = section?.querySelector('.generated-content-wrapper');
                if (contentWrapper?.textContent.trim()) {
                    // Adiciona o texto da se√ß√£o e duas quebras de linha para separar os par√°grafos.
                    transcript += contentWrapper.textContent.trim() + '\n\n';
                }
            });
            
            return transcript.trim();
        };
    
        /**
         * Calcula o tempo de leitura estimado de um texto.
         * @param {string} text - O texto a ser analisado.
         * @returns {string} O tempo de leitura formatado (ex: "~1 min 15 seg").
         */
        const calculateReadingTime = (text) => {
            if (!text) return "";
            const wordsPerMinute = 150; // M√©dia para um ritmo de fala moderado
            const words = text.trim().split(/\s+/).length;
            const totalSeconds = (words / wordsPerMinute) * 60;
            
            if (totalSeconds < 1) return "";
            
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.round(totalSeconds % 60);
            
            let timeString = "~";
            if (minutes > 0) {
                timeString += ` ${minutes} min`;
            }
            if (seconds > 0) {
                timeString += ` ${seconds} seg`;
            }
            
            return timeString.trim();
        };

        /**
         * Gera o HTML para uma se√ß√£o do roteiro em formato de acorde√£o,
         * com acorde√µes aninhados para Prompts e Trilha Sonora.
         * @param {string} sectionId - O ID da se√ß√£o (ex: 'intro', 'development').
         * @param {string} title - O t√≠tulo da se√ß√£o a ser exibido.
         * @param {string} content - O conte√∫do do roteiro para a se√ß√£o.
         * @returns {string} O HTML completo da se√ß√£o.
         */
        const generateSectionHtmlContent = (sectionId, title, content) => {
            const mainBodyId = `${sectionId}Body`;
            const mainArrowId = `${sectionId}Arrow`;
            const promptsBodyId = `promptsBody-${sectionId}`;
            const promptsArrowId = `promptsArrow-${sectionId}`;
            const soundtrackBodyId = `soundtrackBody-${sectionId}`;
            const soundtrackArrowId = `soundtrackArrow-${sectionId}`;

            const listenBtnHtml = `<button class="listen-btn" onclick="event.stopPropagation(); playSectionAudio('${sectionId}')" title="Ouvir pr√©via da narra√ß√£o">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg>
            </button>`;

            const regenerateBtnHtml = `<button class="regenerate-btn" onclick="event.stopPropagation(); window.regenerateSection('${sectionId}', '${title}', '${sectionId}')" title="Re-gerar esta se√ß√£o">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg>
            </button>`;

            const copyBtnHtml = `<button class="copy-btn" onclick="event.stopPropagation(); copyTextToClipboard(document.getElementById('${mainBodyId}').querySelector('.generated-content-wrapper').textContent); window.showCopyFeedback(this)">Copiar</button>`;
            
            const headerButtonsHtml = `${listenBtnHtml} ${regenerateBtnHtml} ${copyBtnHtml}`;

            const promptsSectionHtml = `
                <div class="section-prompts">
                    <div class="nested-accordion-header" onclick="event.stopPropagation(); toggleAccordion('${promptsBodyId}', '${promptsArrowId}')">
                        <h4>Recursos Visuais (Prompts)</h4>
                        <svg id="${promptsArrowId}" class="accordion-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                    </div>
                    <div id="${promptsBodyId}" class="accordion-body">
                        <div class="pt-2">
                            <button class="btn btn-secondary btn-small" onclick="window.generatePromptsForSection('${sectionId}Section')">Gerar Prompts de Imagem</button>
                            <div class="prompt-container mt-4"></div>
                        </div>
                    </div>
                </div>`;
            
            const soundtrackSectionHtml = `
                <div class="section-soundtrack">
                    <div class="nested-accordion-header" onclick="event.stopPropagation(); toggleAccordion('${soundtrackBodyId}', '${soundtrackArrowId}')">
                        <h4>Recursos Sonoros (Trilha)</h4>
                        <svg id="${soundtrackArrowId}" class="accordion-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                    </div>
                    <div id="${soundtrackBodyId}" class="accordion-body">
                        <div class="pt-2">
                             <button class="btn btn-secondary btn-small" onclick="window.suggestSoundtrack('${sectionId}Section')">Sugerir Trilha Sonora</button>
                             <div class="soundtrack-container mt-4"></div>
                        </div>
                    </div>
                </div>`;

            return `<div class="accordion-item">
                        <div class="accordion-header" onclick="toggleAccordion('${mainBodyId}', '${mainArrowId}')">
                            <div class="header-content">
                                 <h3>${title}</h3>
                                 <span class="text-xs font-normal text-gray-400 dark:text-gray-500">${calculateReadingTime(content)}</span>
                                 <svg id="${mainArrowId}" class="accordion-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                            </div>
                            <div class="header-buttons">
                                ${headerButtonsHtml}
                            </div>
                        </div>
                        <div id="${mainBodyId}" class="accordion-body">
                            <div class="generated-content-wrapper" contenteditable="true">${content.startsWith('<div') ? content : `<p class="whitespace-pre-wrap">${content}</p>`}</div>
                            ${promptsSectionHtml}
                            ${soundtrackSectionHtml}
                        </div>
                    </div>`;
        };
    
        /**
         * Limpa o texto gerado pela IA, removendo metadados e extraindo JSON se necess√°rio.
         * @param {string} text - O texto bruto da IA.
         * @param {boolean} expectJson - Se true, tenta extrair e validar um JSON.
         * @returns {string|null} O texto limpo ou o JSON stringificado, ou null em caso de erro.
         */
        const cleanGeneratedText = (text, expectJson = false) => {
            if (!text) return null;

            if (expectJson) {
                // Encontra o primeiro colchete de abertura ou chave
                const firstBracket = text.indexOf('[');
                const firstBrace = text.indexOf('{');
                let startIndex = -1;

                if (firstBracket !== -1 && firstBrace !== -1) {
                    startIndex = Math.min(firstBracket, firstBrace);
                } else {
                    startIndex = Math.max(firstBracket, firstBrace);
                }
                
                if (startIndex === -1) {
                    console.error("N√£o foi poss√≠vel encontrar um in√≠cio de JSON ('{' ou '[') na resposta.", text);
                    return null;
                }

                // Determina o caractere de fechamento correspondente
                const startChar = text[startIndex];
                const endChar = startChar === '[' ? ']' : '}';

                // Encontra o √∫ltimo caractere de fechamento correspondente
                const endIndex = text.lastIndexOf(endChar);

                if (endIndex === -1) {
                    console.error(`JSON incompleto: caractere de fechamento '${endChar}' n√£o encontrado.`, text);
                    return null;
                }

                const jsonString = text.substring(startIndex, endIndex + 1);

                try {
                    JSON.parse(jsonString); // Valida o JSON
                    return jsonString;
                } catch (e) {
                    console.error("O JSON extra√≠do √© inv√°lido.", e.message, jsonString);
                    return null; // Retorna nulo se a valida√ß√£o falhar
                }
            }
            
            return text.trim();
        };

        /**
         * Remove coment√°rios meta da IA do texto gerado.
         * @param {string} text - O texto gerado pela IA.
         * @returns {string} O texto sem os coment√°rios meta.
         */
        const removeMetaComments = (text) => {
            if (!text) return text;
            // Padr√£o para remover "Here is/are..." ou "Sure, here is..." etc.
            const introPattern = /^(Sure, |Of course, )?(here is|here's|here are|below is|certainly, here is) .*?:\s*\n?/im;
            let cleanedText = text.replace(introPattern, '');
            
            // Remove linhas que come√ßam com "Description:" ou "Hashtags:" se a IA as adicionar
            cleanedText = cleanedText.replace(/^(Description:|Hashtags:)\s*\n?/gim, '');

            return cleanedText.trim();
        };

        // --- IN√çCIO DO NOVO M√ìDULO DE NARRATIVA ---

        const narrativeStructures = {
            storytelling: {
                documentary: "Document√°rio (Factual e Investigativo)",
                heros_journey: "Jornada do Her√≥i (Estrutura √âpica)",
                pixar_spine: "Espinha Dorsal - Pixar (Estrutura Emocional)",
                mystery_loop: "Mist√©rio (com Loop Aberto)",
                twist: "Narrativa com Virada (Twist)"
            },
            storyselling: {
                underdog_victory: "Vit√≥ria do Vira-lata (Conex√£o e Supera√ß√£o)",
                discovery_mentor: "A Grande Descoberta / Mentor Secreto",
                if_not_found_create: "N√£o Encontrei, Ent√£o Criei (Hist√≥ria de Origem)",
                pas: "Problema-Agita√ß√£o-Solu√ß√£o (PAS)",
                bab: "Antes-Depois-Ponte (BAB)"
            }
        };

        const narrativeTooltips = {
            documentary: "Constr√≥i um argumento com fatos, evid√™ncias e uma narra√ß√£o autorit√°ria. Perfeito para v√≠deos expositivos.",
            heros_journey: "Conta uma hist√≥ria de transforma√ß√£o e supera√ß√£o. √ìtimo para narrativas inspiradoras.",
            pixar_spine: "Estrutura emocional de 8 passos (Era uma vez... todo dia... at√© que...). Pergunta para arcos de personagem r√°pidos.",
            mystery_loop: "Apresenta uma pergunta no in√≠cio e a responde no final. Excelente para reter a aten√ß√£o.",
            twist: "Constr√≥i uma expectativa e a quebra com uma revela√ß√£o surpreendente no final.",
            underdog_victory: "Mostra algu√©m com limita√ß√µes que venceu contra tudo e todos. Gera alta conex√£o emocional.",
            discovery_mentor: "Revela um grande segredo ou uma descoberta que mudou tudo. Posi√ß√£o de autoridade.",
            if_not_found_create: "Conta a hist√≥ria de origem de um produto ou servi√ßo criado a partir de uma necessidade pessoal.",
            pas: "Foca em um problema que o p√∫blico tem, agita a dor e apresenta a solu√ß√£o. Perfeito para vendas diretas.",
            bab: "Mostra um cen√°rio 'antes' (o problema), um 'depois' (o resultado ideal) e seu conte√∫do como 'a ponte' para chegar l√°."
        };

        const updateNarrativeStructureOptions = () => {
            const goalSelect = document.getElementById('narrativeGoal');
            const structureSelect = document.getElementById('narrativeStructure');
            if (!goalSelect || !structureSelect) return;

            const goal = goalSelect.value;
            structureSelect.innerHTML = ''; // Limpa as op√ß√µes atuais

            const structures = narrativeStructures[goal];
            for (const key in structures) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = structures[key];
                structureSelect.appendChild(option);
            }
            
            updateMainTooltip();
        };

        const updateMainTooltip = () => {
            const goalSelect = document.getElementById('narrativeGoal');
            const tooltip = document.getElementById('narrativeStructureTooltip');
            if (!goalSelect || !tooltip) return;

            const goal = goalSelect.value;
            const structures = narrativeStructures[goal];
            
            let tooltipContent = '';
            for (const key in structures) {
                tooltipContent += `${structures[key]}: ${narrativeTooltips[key]}

`;
            }
            
            tooltip.setAttribute('data-tooltip', tooltipContent.trim());
        };

        // --- FIM DO NOVO M√ìDULO DE NARRATIVA ---

        /**
         * Constr√≥i o contexto base do prompt com base nos inputs do usu√°rio.
         * @returns {string} O contexto do prompt.
         */
        const getBasePromptContext = () => {
            const channelName = elements.channelName.value.trim();
            const videoTheme = elements.videoTheme.value.trim();
            const targetAudience = elements.targetAudience.value.trim();
            const language = elements.languageSelect.value;
            const languageStyle = elements.languageStyle.value;
            const videoObjective = elements.videoObjective.value;
            const videoDuration = elements.videoDuration.value;
            const speakingPace = elements.speakingPace.value;
            const narrativeStructure = document.getElementById('narrativeStructure').value;
            
            // --- IN√çCIO DA LEITURA DOS NOVOS CAMPOS ---
            const narrativeTheme = document.getElementById('narrativeTheme').value.trim();
            const narrativeTone = document.getElementById('narrativeTone').value;
            const narrativeVoice = document.getElementById('narrativeVoice').value.trim();
            // --- FIM DA LEITURA DOS NOVOS CAMPOS ---

            const videoDescription = elements.videoDescription.value.trim();
            const centralQuestion = elements.centralQuestion.value.trim();
            const emotionalArc = elements.emotionalArc.value.trim();
            // REMOVIDO: const viralElements = elements.viralElements.value.trim();
            const imageDescriptionEngine = elements.imageDescriptionEngine.value.trim();
            const imageStyleSelect = elements.imageStyleSelect.value;
            const customImageStyle = elements.customImageStyle.value.trim();

            let context = `
            You are an expert YouTube scriptwriter for the channel "${channelName}".
            Your goal is to create highly engaging and viral video content.
            
            **Core Project Details:**
            - Video Topic: "${videoTheme}"
            - Target Audience: "${targetAudience}"
            - Language: "${language}"
            - Video Objective: "${videoObjective}"
            - Desired Duration: "${videoDuration}"
            
            **Narrative & Style Instructions:**
            - Narrative Structure to use: "${narrativeStructure}"
            - Speaking Pace: "${speakingPace}"
            `;

            // --- IN√çCIO DA INJE√á√ÉO DOS NOVOS DADOS NO CONTEXTO ---
            if (narrativeTheme) {
                context += `\n- Core Theme (The Big Idea): "${narrativeTheme}"`;
            }
            if (narrativeTone) {
                context += `\n- Narrative Tone (The Feeling): "${narrativeTone}"`;
            }
            if (narrativeVoice) {
                context += `\n- Narrator's Voice (The Personality): "${narrativeVoice}"`;
            }
            // --- FIM DA INJE√á√ÉO DOS NOVOS DADOS NO CONTEXTO ---

            if (videoDescription) { context += `\n\n**Additional Information & Inspiration:**\n- Inspiration/Context: "${videoDescription}"`; }
            if (centralQuestion) { context += `\n- Central Question to guide the entire script: "${centralQuestion}"`; }
            if (emotionalArc) { context += `\n- Desired Emotional Arc: "${emotionalArc}"`; }
            // REMOVIDO: if (viralElements) { context += `\n- Viral Elements to incorporate: "${viralElements}"`; }
            
            if (imageStyleSelect === 'cinematic' || imageStyleSelect === 'custom') {
                context += `\n\n**Visual Style Instructions:**`;
                if (imageDescriptionEngine) { context += `\n- Image Description Keywords: "${imageDescriptionEngine}"`; }
                if (imageStyleSelect === 'cinematic') {
                    context += `\n- Image Style: ${CINEMATIC_STYLE_BLOCK}`;
                } else if (imageStyleSelect === 'custom' && customImageStyle) {
                    context += `\n- Custom Image Style: ${customImageStyle}`;
                }
            }

            return context;
        };
    
        /**
         * Constr√≥i o prompt espec√≠fico para cada sec√ß√£o do roteiro ou tipo de conte√∫do.
         * @param {string} sectionName - O nome da sec√ß√£o (ex: 'intro', 'titles_thumbnails').
         * @param {string} sectionTitle - O t√≠tulo da sec√ß√£o para o prompt.
         * @param {string|null} outlineDirective - Uma diretriz espec√≠fica do esbo√ßo estrat√©gico para esta sec√ß√£o.
         * @returns {{prompt: string, maxTokens: number}} O prompt e o limite de tokens.
         */
        const constructScriptPrompt = (sectionName, sectionTitle, outlineDirective = null) => {
            const baseContext = getBasePromptContext();
            const videoDuration = elements.videoDuration.value;
            const selectedLanguage = elements.languageSelect.value;
            const narrativeStyle = document.getElementById('narrativeStructure').value; 

            let prompt = `${baseContext}

You are a master screenwriter, a true virtuoso of words. Your task is to write the **${sectionTitle}** section of the script.

**Your writing must be magnetic and professional. Follow these core principles:**
1.  **Dynamic Rhythm and Pacing:** Write with a natural, captivating cadence. Use a mix of short, punchy sentences for impact and longer, flowing sentences for description and atmosphere. Avoid monotony at all costs.
2.  **"Show, Don't Tell" on a Deeper Level:** Don't just state facts. Use vivid, sensory language to paint a picture in the viewer's mind. Evoke emotions and create a tangible experience through your words.
3.  **Human Connection:** Weave the information into a narrative that connects with the viewer on a personal level. Use "you" to speak directly to them. Ground abstract concepts in relatable human experiences and emotions.
4.  **Rhetorical Techniques:** Intelligently use rhetorical questions, powerful analogies, and striking metaphors to make the content more memorable and thought-provoking.
5.  **Hook Reinforcement:** If there is a central question, subtly remind the viewer of the mystery or the promise made in the introduction to keep them hooked and eager for the resolution.
`;
            let maxTokens = 2000;

            if (outlineDirective) {
                prompt += `\n\n**IMPORTANT STRATEGIC GUIDELINE:** For this specific section, you MUST follow this strategic plan: "${outlineDirective}"`;
            }

            prompt += `\n\nIMPORTANT: Do NOT include any scene descriptions, visual/audio cues (e.g., [SHOT], (Camera pan), (Music swells)), or speaker labels (e.g., "Narrator:", "Host:") in the generated script content. Provide only the spoken text.`;
            prompt += `\n\nABSOLUTELY NO META-COMMENTS. Do not add any explanatory text about the script itself. Your entire response must be ONLY the text to be spoken in the video, and nothing else.`;

            if (elements.centralQuestion.value.trim()) {
                prompt += `\nIf a 'Central Question' is provided, ensure every section of the script (Introduction, Development, Climax) directly contributes to exploring or answering this question. The entire video must revolve around this central theme.`;
            }

            // --- IN√çCIO DA NOVA L√ìGICA DE NARRATIVA ---
            switch (narrativeStyle) {
                case 'documentary':
                    prompt += `\n\nNARRATIVE STYLE: Use a 'Documentary' structure.
                    - **Introduction:** Start with a powerful, factual statement or a thought-provoking question that establishes the central theme. Present the "thesis" of the documentary.
                    - **Development:** Build the narrative by presenting evidence, data, and historical context in a logical sequence. Structure it like an an investigation, revealing information progressively. Use language that suggests authority and credibility (e.g., "Evidence suggests...", "Historical records show...", "Experts believe...").
                    - **Climax:** Present the most compelling piece of evidence or the central conclusion of your argument. This should be the moment where the "thesis" from the introduction is proven or deeply explored.
                    - **Conclusion:** Summarize the key findings and arguments. End with a broader reflection on the implications of the topic, leaving the viewer with a new understanding or perspective.`;
                    break;
                case 'pixar_spine':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'Pixar Spine' structure.
                    - **Introduction:** Era uma vez... (Introduce the main character and their ordinary world). Todo dia... (Describe their routine and the status quo).
                    - **Development:** At√© que um dia... (The inciting incident that changes everything). E por causa disso... (The character's journey begins, facing a series of challenges and events). E por causa disso... (The stakes get higher).
                    - **Climax:** At√© que finalmente... (The character faces the final confrontation or overcomes the main obstacle).
                    - **Conclusion:** E desde ent√£o... (Describe the new normal and the character's transformation).`;
                    break;
                case 'underdog_victory':
                     prompt += `\n\nNARRATIVE STYLE: Use the 'Victory of the Underdog' structure.
                    - **Introduction:** Present a character or entity in a disadvantaged, underestimated, or limited situation (the 'underdog').
                    - **Development:** Detail the immense challenges, the unfair obstacles, and the moments of doubt and struggle they faced. Emphasize their resilience and determination.
                    - **Climax:** The moment of ultimate triumph, where the underdog overcomes the final, greatest obstacle against all odds.
                    - **Conclusion:** Reflect on the victory, connecting it to a universal message of hope, perseverance, or potential, inspiring the audience with a "if they can do it, so can I" feeling.`;
                    break;
                case 'discovery_mentor':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'Great Discovery / Secret Mentor' structure.
                    - **Introduction:** Start with the "before" state - a life of struggle, confusion, or mediocrity. Hint that a breakthrough is coming.
                    - **Development:** Describe the moment of discovery or the encounter with a mentor. Explain the 'secret' or the new perspective that was revealed. Show how this new knowledge was applied and the first signs of change.
                    - **Climax:** Detail the peak result or the ultimate transformation achieved by applying this secret knowledge.
                    - **Conclusion:** Share the core lesson of the discovery and offer it to the audience, positioning the content as a guide to achieve similar results.`;
                    break;
                case 'if_not_found_create':
                     prompt += `\n\nNARRATIVE STYLE: Use the 'I Couldn't Find It, So I Created It' structure.
                    - **Introduction (The Problem):** Describe a personal and relatable problem you (or the protagonist) faced. Explain the frustration of searching for a solution and finding nothing adequate.
                    - **Development (The Creation):** Detail the journey of deciding to create your own solution. Describe the trial and error, the hard work, and the key insights learned along the way.
                    - **Climax (The Solution):** Present the final, successful creation (the product, the service, the method). Show how it solved the original problem perfectly.
                    - **Conclusion (The Offer):** Offer this solution to the audience, who likely share the same original problem.`;
                    break;
                case 'mystery_loop':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'Mystery/Open Loop' structure.
                    - In the **Introduction**, present a compelling central question or mystery and promise the answer by the end.
                    - In the **Development**, build suspense by exploring clues and theories, occasionally reminding the viewer of the central question.
                    - In the **Climax**, deliver the satisfying answer to the question posed in the introduction.`;
                    break;
                case 'pas':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'Problem-Agitate-Solution' structure.
                    - Frame the **Introduction** around a clear 'Problem' that the audience can relate to.
                    - Use the first part of the **Development** to 'Agitate' this problem, explaining its importance and complexity.
                    - Frame the rest of the **Development** and the **Climax** as the 'Solution' or the revealing insight that addresses the initial problem.`;
                    break;
                case 'twist':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'False Climax & Twist' structure.
                    - In the **Development**, build evidence towards a seemingly obvious conclusion (the 'false climax').
                    - In the **Climax**, introduce a surprising new piece of information or a counter-argument that completely changes the expected outcome (the 'twist').
                    - The **Conclusion** should reflect on the implications of this new, unexpected truth.`;
                    break;
                case 'heros_journey':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'Hero's Journey' structure.
                    - **Introduction:** Present the 'Ordinary World' and the 'Call to Adventure'. Introduce the central character or concept.
                    - **Development:** This is the 'Special World'. Describe the trials, allies, and enemies. Build the character's transformation through challenges.
                    - **Climax:** The 'Ordeal' or the final battle. The moment of greatest tension and the hero's ultimate test.
                    - **Conclusion:** The 'Return with the Elixir'. Show the resolution, what was learned, and how the 'Ordinary World' has changed because of the journey.`;
                    break;
                case 'bab':
                    prompt += `\n\nNARRATIVE STYLE: Use the 'Before-After-Bridge' (BAB) structure.
                    - **Introduction (Before):** Describe the 'Before' state. A world without the knowledge or solution you're about to present. Paint a picture of the problem or the lack of understanding.
                    - **Development (After):** Describe the 'After' state. A desirable world where the problem is solved or the knowledge is revealed. Show the benefits and the ideal outcome.
                    - **Climax & Conclusion (The Bridge):** Present your content as 'The Bridge'. Explain how your video's information is the exact path to get from the 'Before' state to the 'After' state. This is the solution, the 'how-to'.`;
                    break;
            }

            // O resto da fun√ß√£o continua...
            // ...
            switch (sectionName) {
                case 'outline': // New case for strategic outline
                    prompt = `${baseContext}

Voc√™ √© um mestre roteirista e estrategista de conte√∫do. Sua tarefa √© criar um "beat sheet" ou um esbo√ßo estrat√©gico detalhado para o v√≠deo. Analise todos os par√¢metros fornecidos (tema, p√∫blico, estilo narrativo, etc.) para criar a estrutura mais impactante poss√≠vel.

Responda APENAS com um objeto JSON. O objeto deve conter chaves para cada parte principal do roteiro: "introduction", "development", "climax", "conclusion", e "cta".

O valor de cada chave deve ser uma string descrevendo o objetivo, o conte√∫do e a emo√ß√£o daquela sec√ß√£o espec√≠fica. Seja conciso, mas estrat√©gico.

Exemplo de formato JSON esperado:
{
  "introduction": "Come√ßar com uma pergunta ret√≥rica chocante sobre a mortalidade, seguida por uma promessa de que a hist√≥ria de L√°zaro det√©m uma resposta inesperada. Gancho emocional: curiosidade e um toque de medo existencial.",
  "development": "Construir a narrativa explorando o luto das irm√£s de L√°zaro, humanizando a hist√≥ria. Apresentar a chegada tardia de Jesus como um ponto de tens√£o e d√∫vida. Foco na emo√ß√£o de perda antes do milagre.",
  "climax": "O momento de maior tens√£o no t√∫mulo. Descrever a ordem de Jesus com autoridade e o espanto da multid√£o. O milagre deve ser o pico emocional e visual do v√≠deo.",
  "conclusion": "Resumir a li√ß√£o: o milagre n√£o √© sobre desafiar a morte, mas sobre o poder da f√©. Conectar a hist√≥ria de L√°zaro √† jornada de f√© pessoal do espectador.",
  "cta": "Fazer uma chamada para a√ß√£o suave, pedindo para o espectador compartilhar sua pr√≥pria hist√≥ria de supera√ß√£o ou f√© nos coment√°rios, criando uma comunidade."
}
`;
                    maxTokens = 1500;
                    break;
                case 'intro':
                    prompt += `
                    The introduction should hook the viewer immediately, clearly state the video's intriguing question or mystery, and set the stage for what's to come. It must be captivating and create curiosity. For a "${videoDuration}" video, make this introduction appropriate in length and detail.
                    `;
                    if (selectedLanguage === 'pt-br' || selectedLanguage === 'pt-pt') {
                        prompt += `\n**IMPORTANT: The response for this section MUST be in Portuguese.**`;
                    }
                    maxTokens = 500;
                    break;
                case 'development':
                    prompt += `
                    The development section should delve into the core topic, presenting facts, arguments, and historical context. It should maintain a strong narrative flow, building suspense and providing compelling information. Break down complex ideas into easily digestible parts. For a "${videoDuration}" video, ensure this section is comprehensive but also flows well, adapting its length to the desired duration.
                    `;
                    maxTokens = 1500;
                    break;
                case 'climax':
                    prompt += `
                    The climax should be the most impactful part of the video, revealing key insights, surprising twists, or the most compelling evidence related to the video theme. It should be dramatic and leave the viewer with a sense of awe or profound understanding. For a "${videoDuration}" video, make this climax impactful and well-paced.
                    `;
                    if (selectedLanguage === 'pt-br' || selectedLanguage === 'pt-pt') {
                        prompt += `\n**IMPORTANT: The response for this section MUST be in Portuguese.**`;
                    }
                    maxTokens = 500;
                    break;
                case 'conclusion':
                    prompt += `
                    The conclusion should summarize the main points, provide a final thought or reflection, and leave the viewer with a lasting impression. Ensure the conclusion is complete and well-rounded, providing a sense of closure. For a "${videoDuration}" video, make this conclusion concise yet impactful.
                    `;
                    if (selectedLanguage === 'pt-br' || selectedLanguage === 'pt-pt') {
                        prompt += `\n**IMPORTANT: The response for this section MUST be in Portuguese.**`;
                    }
                    maxTokens = 500;
                    break;
                case 'cta':
                    prompt += `
                    The Call to Action (CTA) should be clear and concise, encouraging viewers to subscribe, like, comment, or share. It should be compelling and feel like a natural conclusion to the video. For a "${videoDuration}" video, keep this CTA direct and effective, **but ensure it is a complete and well-rounded paragraph.**
                    `;
                    maxTokens = 400; 
                    break;
                case 'titles_thumbnails':
                    prompt = `${baseContext}
Generate 5 highly clickable and viral YouTube video titles and 5 compelling thumbnail ideas.

IMPORTANT: Respond ONLY with a valid JSON object. Do not include any other text, preambles, or explanations outside of the JSON structure itself.

The JSON object must have two top-level keys:
1.  "titles": An array of strings.
2.  "thumbnails": Anatah array of objects, where each object has a "title" (string) and a "description" (string) key. Each description should focus on strong visual elements, emotions, and clear text overlays.

The final output MUST be only the JSON code, like this example:
{
  "titles": [
    "The Shocking Truth About the Ark of the Covenant",
    "Was the Ark of the Covenant Finally Discovered?",
    "This Ancient Secret Could Change History Forever",
    "Biblical Mystery: The Ark's Final Location Revealed",
    "They Found It? The Search for the Lost Ark Ends Here"
  ],
  "thumbnails": [
    {
      "title": "FOUND?",
      "description": "A dramatic image of an ancient, glowing chest half-buried in a dark cave, with an astonished archaeologist looking on."
    },
    {
      "title": "TOP SECRET",
      "description": "A collage showing a faded ancient map, a secret biblical text, and a satellite image pointing to a location in Ethiopia."
    },
    {
      "title": "HISTORY CHANGED",
      "description": "A visually stunning image of the Ark of the Covenant radiating golden light inside a reconstructed Solomon's Temple."
    }
  ]
}
`;
                    maxTokens = 800;
                    break;
                case 'description':
                    prompt = `${baseContext}\n\nGenerate a compelling YouTube video description (around 150-200 words) that summarizes the video, includes relevant keywords for SEO, and encourages engagement. Include a strong hook, a brief overview of the content, and a call to action. Also, suggest 10 relevant hashtags.
                    Output format:
                    Description:
                    [Your description here]

                    Hashtags:
                    #hashtag1 #hashtag2 ...
                    `;
                    maxTokens = 700;
                    break;
                default:
                    maxTokens = 1000;
                    break;
            }
            return { prompt, maxTokens };
        };

        /**
         * Faz uma chamada √† API Groq atrav√©s de uma fun√ß√£o Netlify.
         * @param {string} prompt - O prompt a ser enviado para a IA.
         * @param {number} maxTokens - O n√∫mero m√°ximo de tokens para a resposta.
         * @returns {Promise<string>} A resposta bruta da IA.
         * @throws {Error} Se a chamada √† API falhar.
         */
        const callGroqAPI = async (prompt, maxTokens) => {
            const proxyUrl = "/.netlify/functions/groq"; // Endpoint do proxy

            const payload = {
                prompt: prompt,
                maxTokens: maxTokens
            };

            const request = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetch(proxyUrl, request);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: 'Erro desconhecido do servidor proxy.' } }));
                    throw new Error(`Erro na API via Proxy: ${errorData.error?.message || 'Erro do servidor'}`);
                }
                const result = await response.json();
                const rawContent = result.choices?.[0]?.message?.content;
                if (rawContent) { return rawContent; }
                else { throw new Error("Resposta inesperada da API Groq."); }
            } catch (error) {
                console.error("Fetch da API via Netlify Function falhou:", error);
                window.showToast(`Falha na API: ${error.message}`);
                throw error;
           }
        };

        /**
         * Valida os inputs essenciais antes de gerar conte√∫do.
         * @returns {boolean} True se os inputs s√£o v√°lidos, caso contr√°rio, false.
         */
        const validateInputs = () => {
            if (!elements.channelName.value.trim()) {
                window.showToast("Por favor, insira o nome do canal.");
                return false;
            }
            if (!elements.videoTheme.value.trim()) {
                window.showToast("Por favor, insira o tema do v√≠deo.");
                return false;
            }
            if (!elements.videoDescription.value.trim()) {
                window.showToast("Por favor, insira a descri√ß√£o do v√≠deo (para inspira√ß√£o).");
                return false;
            }
            if (!elements.videoDuration.value || elements.videoDuration.value === "") {
                window.showToast("Por favor, selecione a Dura√ß√£o Desejada do v√≠deo.");
                return false;
            }
            return true;
        };

        /**
         * Itera sobre todas as se√ß√µes do roteiro na ordem correta,
         * renumera globalmente todas as cenas E recalcula o timestamp
         * com base na dura√ß√£o estimada pela IA para cada cena.
         */
        const reNumberAllScenes = () => {
            let globalSceneCounter = 1;
            totalScriptSeconds = 0;
            const sectionOrder = ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection', 'ctaSection'];

            sectionOrder.forEach(sectionId => {
                const promptBlocks = document.querySelectorAll(`#${sectionId} .individual-prompt-block`);
                
                promptBlocks.forEach(block => {
                    const timeElement = block.querySelector('.prompt-time');
                    if (timeElement) {
                        // L√™ a dura√ß√£o do atributo data-duration
                        const sceneDuration = parseInt(block.dataset.duration, 10) || 18; // Usa 18 como fallback
                        
                        const minutes = Math.floor(totalScriptSeconds / 60);
                        const seconds = Math.floor(totalScriptSeconds % 60);
                        
                        timeElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} - Cena ${String(globalSceneCounter).padStart(2, '0')}`;
                        
                        totalScriptSeconds += sceneDuration;
                        globalSceneCounter++;
                    }
                });
            });
        };
    
        // ==========================================================
        // ================== FUN√á√ïES PRINCIPAIS ====================
        // ==========================================================

        /**
         * Gera, reproduz e INICIA O DOWNLOAD do √°udio para uma se√ß√£o espec√≠fica do roteiro.
         * @param {string} sectionId - O ID do elemento da se√ß√£o (ex: 'introSection').
         */
        const playSectionAudio = async (sectionId) => {
            const sectionElement = document.getElementById(sectionId);
            const button = sectionElement.querySelector('.listen-btn');
            const icon = button.querySelector('svg');
            const originalIconHTML = icon.innerHTML;
            const audioPlayer = document.getElementById('audioPlayer');

            // Para o √°udio atual se um novo for solicitado
            if (!audioPlayer.paused) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            }

            const textToSpeak = sectionElement.querySelector('.generated-content-wrapper')?.textContent;
            if (!textToSpeak) {
                window.showToast("N√£o h√° texto para ouvir nesta se√ß√£o.");
                return;
            }

            icon.innerHTML = `<path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>`;
            icon.classList.add('animate-spin');
            button.disabled = true;

            try {
                const response = await fetch('/.netlify/functions/gemini-tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ textToSpeak })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Falha ao gerar o √°udio.');
                }

                const { audioBase64 } = await response.json();
                const audioUrl = `data:audio/mpeg;base64,${audioBase64}`;
                
                // A√ß√£o 1: Reproduzir o √°udio
                audioPlayer.src = audioUrl;
                audioPlayer.play();

                // --- IN√çCIO DA NOVA L√ìGICA DE DOWNLOAD ---
                // A√ß√£o 2: Iniciar o download do arquivo de √°udio
                const downloadLink = document.createElement('a');
                downloadLink.href = audioUrl;
                
                // Cria um nome de arquivo inteligente
                const sectionTitle = sectionElement.querySelector('h3')?.textContent.trim().replace(/[^a-zA-Z0-9]/gi, '_').toLowerCase() || sectionId;
                const fileName = `${sectionTitle}_audio.mp3`;
                downloadLink.download = fileName;
                
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                // --- FIM DA NOVA L√ìGICA DE DOWNLOAD ---

                window.showToast(`Reproduzindo e baixando √°udio de "${sectionElement.querySelector('h3')?.textContent || 'se√ß√£o'}"!`);

            } catch (error) {
                window.showToast(error.message);
                console.error("Erro na reprodu√ß√£o de √°udio:", error);
            } finally {
                icon.classList.remove('animate-spin');
                icon.innerHTML = originalIconHTML;
                button.disabled = false;
            }
        };

        /**
         * Lida com a gera√ß√£o de uma sec√ß√£o espec√≠fica do roteiro.
         * @param {HTMLElement} button - O bot√£o que acionou a gera√ß√£o.
         * @param {string} sectionName - O nome da sec√ß√£o (ex: 'intro').
         * @param {string} sectionTitle - O t√≠tulo da sec√ß√£o para exibi√ß√£o.
         * @param {string} elementId - O ID do elemento HTML onde o conte√∫do ser√° inserido (ex: 'intro').
         */
        const handleGenerateSection = async (button, sectionName, sectionTitle, elementId) => {
            if (!validateInputs()) return;
            
            // Logo no in√≠cio da fun√ß√£o
            if (!strategicOutline) {
                window.showToast("Crie o Esbo√ßo Estrat√©gico primeiro!");
                return;
            }

            showLoading(button);
            try {
                // Pega a diretriz espec√≠fica para esta sec√ß√£o do nosso esbo√ßo global
                const directive = strategicOutline[sectionName]; 
                
                const { prompt, maxTokens } = constructScriptPrompt(sectionName, sectionTitle, directive);
                let result = await callGroqAPI(prompt, maxTokens);
                
                // Limpeza espec√≠fica de metadados da IA
                result = result.replace(/^Here's (?:the|a potential) \*\*[\w\s]+\*\* (?:section of the video script|for the video script):\s*\n*\s*$/gm, '');
                result = result.replace(/^(?:Host|Narrator)(?:\s*\(.*?\))?:\s*/gm, '');
                result = result.replace(/^\*\*[\w\s]+\*\*$/gm, '');
                result = result.replace(/^\s*(?:\*\*?\[.*?\]\*\*?|\(.*?\))\s*$/gm, '');
                result = result.replace(/^\s*[\r\n]+/gm, '');

                result = cleanGeneratedText(result, false);
                result = removeMetaComments(result);

                const targetSectionElement = document.getElementById(`${elementId}Section`);
                if (targetSectionElement) {
                    const sectionHtml = generateSectionHtmlContent(elementId, sectionTitle, result);
                    targetSectionElement.innerHTML = sectionHtml;
                    const accordionItem = targetSectionElement.querySelector('.accordion-item');
                    if(accordionItem) accordionItem.classList.add('animate-fade-in');
                } else {
                    console.error(`Target section element with ID '${elementId}Section' not found.`);
                    window.showToast("Erro interno: Sec√ß√£o do roteiro n√£o encontrada.");
                    return;
                }
                
                markButtonAsCompleted(button.id);
                updateButtonStates();

            } catch (error) {
                window.showToast(`Falha ao gerar ${sectionTitle}: ${error.message}`);
                console.error(`Error generating ${sectionTitle}.`, error);
            } finally {
                hideLoading(button);
            }
        };

        /**
         * Re-gera o conte√∫do de uma sec√ß√£o espec√≠fica do roteiro.
         * Chamada pelos bot√µes "Re-gerar" dentro das sec√ß√µes.
         * @param {string} sectionName - O nome da sec√ß√£o (ex: 'intro').
         * @param {string} sectionTitle - O t√≠tulo da sec√ß√£o.
         * @param {string} elementId - O ID do elemento HTML da sec√ß√£o.
         */
        window.regenerateSection = (sectionName, sectionTitle, elementId) => {
            const mainButtonIdMap = {
                'intro': 'generateIntroBtn',
                'development': 'generateDevelopmentBtn',
                'climax': 'climaxBtn',
                'conclusion': 'conclusionBtn',
                'cta': 'generateCTABtn'
            };
            const buttonId = mainButtonIdMap[sectionName];
            if (buttonId) {
                const button = document.getElementById(buttonId);
                handleGenerateSection(button, sectionName, sectionTitle, elementId);
            }
        };

        /**
	 * Gera prompts de imagem para uma se√ß√£o espec√≠fica do roteiro.
         */
        window.generatePromptsForSection = async (sectionElementId) => {
            const sectionElement = document.getElementById(sectionElementId);
            const scriptContentElement = sectionElement.querySelector('.generated-content-wrapper');
            const promptContainer = sectionElement.querySelector('.prompt-container');
            
            if (!scriptContentElement || !scriptContentElement.textContent.trim()) {
                window.showToast("Por favor, gere o conte√∫do do roteiro desta se√ß√£o primeiro.");
                return;
            }

            const scriptContent = scriptContentElement.textContent;
            promptContainer.innerHTML = `<div class="loading-spinner-small"></div>`;
            const imageDescriptionEngine = elements.imageDescriptionEngine.value.trim();
            const imageStyleSelect = elements.imageStyleSelect.value;
            const customImageStyle = elements.customImageStyle.value.trim();
            let selectedStyleBlock = '';

            // --- IN√çCIO DO PROMPT FINAL E INTELIGENTE ---
            let prompt = `Voc√™ √© um Diretor de Arte e Roteirista de Storyboard. Sua tarefa √© analisar o trecho de roteiro abaixo e criar um storyboard visual com ritmo din√¢mico.

**SUA TAREFA MAIS IMPORTANTE √â O RITMO:**
1.  Leia um bloco de frases do roteiro.
2.  **Estime** quantos segundos levaria para narrar esse bloco de texto (o ideal √© entre 15 e 25 segundos).
3.  Crie UMA √∫nica imagem que represente visualmente a ideia principal desse bloco de texto.
4.  Retorne a frase principal que resume o bloco, a descri√ß√£o da imagem e a sua estimativa de dura√ß√£o.

**REGRAS INEGOCI√ÅVEIS:**
-   **N√ÉO** descreva movimentos de c√¢mera, cortes ou enquadramentos. Descreva APENAS o conte√∫do visual est√°tico.
-   A resposta DEVE SER um array JSON. Cada objeto no array DEVE ter **exatamente** tr√™s chaves: \`scriptPhrase\`, \`imageDescription\`, e \`estimated_duration\` (n√∫mero de segundos).

**EXEMPLO DE RESPOSTA PERFEITA:**
[
  {
    "scriptPhrase": "Imagine being in Mary's shoes, feeling the weight of grief.",
    "imageDescription": "A dimly lit, rustic room where a woman sits alone, head bowed in sorrow, a single tear tracing a path on her cheek. The atmosphere is heavy with loss.",
    "estimated_duration": 18
  },
  {
    "scriptPhrase": "The news of Lazarus' death reaches Jesus, but his response is not what they expected.",
    "imageDescription": "A solitary figure of Jesus stands on a dusty road, looking towards a distant silhouette of a village, his expression is calm and determined, not rushed.",
    "estimated_duration": 22
  }
]

Agora, analise o seguinte trecho de roteiro e gere o JSON:
---
${scriptContent}
---`;
            // --- FIM DO PROMPT FINAL E INTELIGENTE ---
            
            if (imageDescriptionEngine) {
                prompt += `\n\nAlso, ensure the image descriptions incorporate the following quality instructions: "${imageDescriptionEngine}"`;
            }
            if (imageStyleSelect === 'cinematic') {
                prompt += `\n\nApply a cinematic film still style to these image descriptions: ${CINEMATIC_STYLE_BLOCK}`;
                selectedStyleBlock = CINEMATIC_STYLE_BLOCK;
            } else if (imageStyleSelect === 'custom' && customImageStyle) {
                prompt += `\n\nApply the following custom image style to these image descriptions: ${customImageStyle}`;
                selectedStyleBlock = customImageStyle;
            }

            try {
                const rawResult = await callGroqAPI(prompt, 4000);
                const cleanedText = cleanGeneratedText(rawResult, true);
                let prompts = [];
                if (cleanedText) {
                    try {
                        prompts = JSON.parse(cleanedText);
                        if (!Array.isArray(prompts)) {
                            prompts = [prompts];
                        }
                    } catch (e) {
                        window.showToast("Erro ao analisar JSON de prompts de imagem. Verifique o console.");
                        console.error("Erro ao analisar JSON de prompts de imagem:", e);
                    }
                } else {
                    window.showToast("Erro: IA n√£o retornou prompts ou o formato est√° incorreto para esta se√ß√£o.");
                }
                
                allImagePrompts[sectionElementId] = prompts.map((p) => ({ ...p, styleBlock: selectedStyleBlock }));

                promptContainer.innerHTML = '';
                if (allImagePrompts[sectionElementId] && allImagePrompts[sectionElementId].length > 0) {
                    allImagePrompts[sectionElementId].forEach((promptData, index) => {
                        const styleBlockContent = promptData.styleBlock || '';
                        // Adiciona a dura√ß√£o estimada como um atributo de dados para a fun√ß√£o de renumera√ß√£o ler
                        const promptHtml = `
                            <div class="individual-prompt-block card-background" data-duration="${promptData.estimated_duration || 18}">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="prompt-time">00:00 - Cena 00</p> 
                                    <button class="copy-btn" onclick="copyTextToClipboard(document.getElementById('prompt-content-${sectionElementId}-${index}').textContent + ' ' + document.getElementById('style-block-${sectionElementId}-${index}').textContent); window.showCopyFeedback(this)">Copiar</button>
                                </div>
                                <p class="prompt-phrase">${promptData.scriptPhrase}</p>
                                <p class="prompt-description-label">${imageDescriptionLabels[elements.languageSelect.value] || 'Image Description:'}</p>
                                <p id="prompt-content-${sectionElementId}-${index}" class="prompt-description-content">${promptData.imageDescription}</p>
                                <pre id="style-block-${sectionElementId}-${index}" class="text-xs p-2 rounded-md overflow-auto">${styleBlockContent}</pre>
                            </div>
                        `;
                        promptContainer.innerHTML += promptHtml;
                    });
                } else {
                    promptContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhum prompt gerado para esta se√ß√£o.</p>';
                }
                
                reNumberAllScenes();
                updateButtonStates();
            } catch (error) {
                promptContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao gerar prompts: ${error.message}</p>`;
                console.error(`Error generating prompts for section ${sectionElementId}.`, error);
            }
        };
    
        /**
         * Sugere trilhas sonoras para uma sec√ß√£o espec√≠fica do roteiro.
         * @param {string} sectionId - O ID do elemento HTML da sec√ß√£o (ex: 'introSection').
         */
        window.suggestSoundtrack = async (sectionId) => {
            const sectionElement = document.getElementById(sectionId);
            const scriptContent = sectionElement.querySelector('.generated-content-wrapper').textContent; 
            const soundtrackContainer = sectionElement.querySelector('.soundtrack-container');
            
            if (!scriptContent) {
                window.showToast("Gere o roteiro para esta sec√ß√£o primeiro.");
                return;
            }

            soundtrackContainer.innerHTML = `<div class="loading-spinner-small"></div>`; 

            const prompt = `Voc√™ √© um especialista em prompts para IAs de gera√ß√£o de m√∫sica (como Suno/Udio). Sua tarefa √© analisar o seguinte trecho de roteiro e criar 3 prompts de texto distintos e detalhados.

**REGRAS DE FORMATA√á√ÉO (N√ÉO NEGOCI√ÅVEIS):**1.  Sua resposta DEVE SER um array JSON v√°lido.2.  O array deve conter EXATAMENTE 3 strings.3.  CADA string deve ser um par√°grafo √∫nico, bem escrito e descritivo, pronto para ser colado em uma IA de m√∫sica. N√ÉO use chaves, colchetes ou qualquer outra sintaxe de objeto DENTRO da string do prompt.

**EXEMPLO DE RESPOSTA PERFEITA:**
["Generate an epic, cinematic orchestral piece in the style of Hans Zimmer... No vocals or percussion, focus on the emotional intensity of the strings and piano.","Create a contemplative, melancholic ambient track with a slow, mournful tempo... No bright or cheerful notes, focus on the darker, more introspective tones.","Craft an uplifting, inspirational electronic piece with a moderate tempo... avoid any jarring or harsh sounds, focusing on the soaring, inspirational quality of the melody."
]

Agora, use o roteiro abaixo como inspira√ß√£o para criar 3 prompts seguindo EXATAMENTE este formato.

Trecho do roteiro para analisar:
---
${scriptContent}
---`;
            
            try {
                const rawResult = await callGroqAPI(prompt, 500);
                const cleanedResult = cleanGeneratedText(rawResult, true);
                const suggestions = JSON.parse(cleanedResult);

                // Adiciona tratamento de erro para garantir que suggestions √© um array de strings
                if (!Array.isArray(suggestions) || !suggestions.every(s => typeof s === 'string')) {
                    throw new Error("A IA retornou um formato de trilha sonora inesperado. Esperava um array de strings.");
                }

                soundtrackContainer.innerHTML = ''; // Limpa o spinner
                if (suggestions && suggestions.length > 0) {
                    // Agora envolvemos a lista em um div com as classes corretas para ter um fundo e padding.
                    let suggestionsHtml = '<div class="card-background p-4 rounded-lg shadow-inner">';
                    suggestionsHtml += '<ul class="soundtrack-list">';
                    suggestions.forEach(suggestion => {
                        suggestionsHtml += `<li>${suggestion}</li>`;
                    });
                    suggestionsHtml += '</ul>';
                    suggestionsHtml += '</div>'; 

                    soundtrackContainer.innerHTML = suggestionsHtml;
                } else {
                    soundtrackContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma sugest√£o de trilha sonora foi gerada.</p>';
                }
            } catch (error) {
                soundtrackContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao gerar sugest√µes: ${error.message}</p>`;
            }
        };

        /**
         * Copia a transcri√ß√£o completa para a √°rea de transfer√™ncia e
         * inicia o download de um arquivo .docx contendo a mesma transcri√ß√£o.
         */
        const handleCopyAndDownloadTranscript = () => {
            const transcriptText = getTranscriptOnly();

            if (!transcriptText) {
                window.showToast("Nenhum roteiro para copiar. Gere as se√ß√µes primeiro.");
                return;
            }

            // A√ß√£o 1: Copiar para a √°rea de transfer√™ncia
            copyTextToClipboard(transcriptText);
            // O showToast j√° est√° dentro do copyTextToClipboard, mas podemos adicionar um mais espec√≠fico.
            window.showToast("Transcri√ß√£o copiada e download iniciado!");

            // A√ß√£o 2: Gerar e baixar o arquivo .docx
            const fileName = (elements.videoTheme.value.trim().replace(/[^a-zA-Z0-9]/gi, '_').toLowerCase() || 'roteiro') + '_transcricao.docx';
            
            // Converte o texto plano em HTML simples, preservando as quebras de linha
            const htmlContent = `<!DOCTYPE html><html><head><meta charset='UTF-8'></head><body>${transcriptText.replace(/\n/g, '<br>')}</body></html>`;
            
            const blob = new Blob([htmlContent], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        };
    
        /**
         * Gera t√≠tulos de v√≠deo e ideias de thumbnail.
         */
        const generateTitlesAndThumbnails = async () => {
            if (!validateInputs()) return;
            showLoading(buttons.generateTitlesAndThumbnailsBtn);
            try {
                // --- IN√çCIO DA CORRE√á√ÉO NO PROMPT ---
                const { prompt, maxTokens } = constructScriptPrompt('titles_thumbnails');
                // Adicionamos uma instru√ß√£o extra para garantir a validade do JSON
                const finalPrompt = prompt + `\n\nCRITICAL RULE: Inside the 'description' strings, you MUST use single quotes ('') for any internal quotes, or properly escape double quotes (\\\"). Failure to do so will result in an invalid JSON. Example: "A text overlay that says 'Hope is Here'".`;
                
                const result = await callGroqAPI(finalPrompt, maxTokens);
                // --- FIM DA CORRE√á√ÉO NO PROMPT ---

                const cleanedResult = cleanGeneratedText(result, true);
                
                if (!cleanedResult) {
                    // Adiciona um log mais detalhado em caso de falha
                    console.error("Falha ao limpar ou validar o JSON retornado pela IA.", result);
                    throw new Error("A IA n√£o retornou um JSON v√°lido.");
                }
                
                const parsedContent = JSON.parse(cleanedResult);
                generatedTitlesAndThumbnails = parsedContent;

                const targetContentElement = document.getElementById('titlesThumbnailsContent');
                if (targetContentElement) {
                    const titlesListHtml = parsedContent.titles.map((title, index) => `<p>${index + 1}. ${title}</p>`).join('');
                    const thumbnailsListHtml = parsedContent.thumbnails.map((thumb, index) => `
                        <div class="${index === 0 ? '' : 'thumbnail-item-separator'}"> 
                            <p class="font-semibold">"${thumb.title}"</p>
                            <p class="text-sm leading-tight">Descri√ß√£o: ${thumb.description}</p>
                        </div>
                    `).join('');

                    targetContentElement.innerHTML = `
                        <div class="space-y-4 text-sm">
                            <div>
                                <h4 class="font-bold text-base mb-2">Sugest√µes de T√≠tulos:</h4>
                                <div class="p-3 card-background rounded-md space-y-2">${titlesListHtml}</div>
                                <div class="mt-3">
                                    <button class="btn btn-secondary btn-small" onclick="window.analyzeTitles()">Analisar CTR</button>
                                    <div id="ctrAnalysisResult" class="mt-3"></div>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-base mb-2">Ideias de Thumbnail:</h4>
                                <div class="p-3 card-background rounded-md space-y-3">${thumbnailsListHtml}</div>
                                <div class="mt-3">
                                    <button class="btn btn-secondary btn-small" onclick="window.analyzeThumbnails()">Analisar Thumbnails</button>
                                    <div id="thumbnailAnalysisResult" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    markButtonAsCompleted(buttons.generateTitlesAndThumbnailsBtn.id);
                }
            } catch (error) {
                window.showToast(`Falha ao gerar T√≠tulos: ${error.message}`);
                console.error("Error generating Titles/Thumbnails.", error);
            } finally {
                hideLoading(buttons.generateTitlesAndThumbnailsBtn);
                updateButtonStates();
            }
        };

        /**
         * Analisa o potencial de clique (CTR) dos t√≠tulos gerados.
         */
        window.analyzeTitles = async () => {
            if (!generatedTitlesAndThumbnails || !generatedTitlesAndThumbnails.titles || generatedTitlesAndThumbnails.titles.length === 0) {
                window.showToast("Gere os t√≠tulos primeiro!");
                return;
            }

            const resultContainer = document.getElementById('ctrAnalysisResult');
            resultContainer.innerHTML = `<div class="loading-spinner-small"></div>`;

            const titlesString = generatedTitlesAndThumbnails.titles.join('\n');
            
            const prompt = `Voc√™ √© um especialista em marketing de conte√∫do para o YouTube. Analise a seguinte lista de t√≠tulos de v√≠deo. Para cada um, forne√ßa uma "nota de CTR" de 0 a 10 (onde 10 √© um clique quase garantido) e uma sugest√£o curta e objetiva para melhor√°-lo, focando em curiosidade, urg√™ncia e benef√≠cio claro.

            Responda APENAS com um array JSON. Cada objeto no array deve ter as chaves "titulo_original", "nota_ctr" e "sugestao_melhora".

            T√≠tulos para analisar:
            ---
            ${titlesString}
            ---`;

            try {
                const rawResult = await callGroqAPI(prompt, 2000);
                const cleanedResult = cleanGeneratedText(rawResult, true);
                const analysis = JSON.parse(cleanedResult);

                let analysisHtml = '<div class="space-y-4">';
                analysis.forEach(item => {
                    analysisHtml += `
                        <div class="p-3 card-background rounded-md shadow-sm">
                            <p class="font-semibold text-gray-800 dark:text-gray-200">${item.titulo_original}</p>
                            <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Nota de CTR:</strong> <span class="text-indigo-500 font-bold">${item.nota_ctr} / 10</span></p>
                            <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Sugest√£o:</strong> ${item.sugestao_melhora}</p>
                        </div>
                    `;
                });
                analysisHtml += '</div>';
                resultContainer.innerHTML = analysisHtml;

            } catch (error) {
                resultContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao analisar os t√≠tulos: ${error.message}</p>`;
            }
        };

        /**
         * Analisa o potencial de clique (CTR) das ideias de thumbnail geradas.
         */
        window.analyzeThumbnails = async () => {
            if (!generatedTitlesAndThumbnails || !generatedTitlesAndThumbnails.thumbnails || generatedTitlesAndThumbnails.thumbnails.length === 0) {
                window.showToast("Gere as ideias de thumbnail primeiro!");
                return;
            }

            const resultContainer = document.getElementById('thumbnailAnalysisResult');
            resultContainer.innerHTML = `<div class="loading-spinner-small"></div>`;

            const thumbnailsString = generatedTitlesAndThumbnails.thumbnails.map(t => `T√≠tulo: ${t.title}, Descri√ß√£o: ${t.description}`).join('\n---\n');
            
            // --- IN√çCIO DA CORRE√á√ÉO NO PROMPT ---
            const prompt = `Voc√™ √© um Diretor de Arte e especialista em YouTube. Analise a seguinte lista de ideias para thumbnails. Para cada uma, forne√ßa uma "nota de potencial visual" de 0 a 10 (onde 10 √© uma imagem irresist√≠vel) e uma sugest√£o curta para maximizar o impacto visual, focando em contraste, emo√ß√£o facial, clareza e curiosidade.

            Responda APENAS com um array JSON. Cada objeto no array deve ter as chaves "titulo", "nota_visual" e "sugestao_melhora". A chave "titulo" DEVE conter o t√≠tulo original da ideia que voc√™ analisou.

            Ideias para analisar:
            ---
            ${thumbnailsString}
            ---`;
            // --- FIM DA CORRE√á√ÉO NO PROMPT ---

            try {
                const rawResult = await callGroqAPI(prompt, 2500);
                const cleanedResult = cleanGeneratedText(rawResult, true);
                const analysis = JSON.parse(cleanedResult);

                let analysisHtml = '<div class="space-y-4">';
                analysis.forEach(item => {
                    // --- IN√çCIO DA CORRE√á√ÉO NA RENDERIZA√á√ÉO ---
                    analysisHtml += `
                        <div class="p-3 card-background rounded-md shadow-sm">
                            <p class="font-semibold text-gray-800 dark:text-gray-200">"${item.titulo || 'Ideia Sem T√≠tulo'}"</p>
                            <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Nota de Potencial Visual:</strong> <span class="text-indigo-500 font-bold">${item.nota_visual} / 10</span></p>
                            <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Sugest√£o:</strong> ${item.sugestao_melhora}</p>
                        </div>
                    `;
                    // --- FIM DA CORRE√á√ÉO NA RENDERIZA√á√ÉO ---
                });
                analysisHtml += '</div>';
                resultContainer.innerHTML = analysisHtml;

            } catch (error) {
                resultContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao analisar as thumbnails: ${error.message}</p>`;
            }
        };
        /**
         * Gera a descri√ß√£o do v√≠deo e hashtags.
         */
        const generateVideoDescription = async () => {
            if (!validateInputs()) return;
            showLoading(buttons.generateDescriptionBtn);
            try {
                let result = await callGroqAPI(constructScriptPrompt('description').prompt, constructScriptPrompt('description').maxTokens);
                result = cleanGeneratedText(result, false);
                result = removeMetaComments(result); // <-- REINTRODUZIMOS A LIMPEZA!
                
                const targetContentElement = document.getElementById('videoDescriptionContent');
                if (targetContentElement) {
                    targetContentElement.innerHTML = `<div class="p-3 text-sm card-background rounded-md whitespace-pre-wrap">${result}</div>`;
                    markButtonAsCompleted(buttons.generateDescriptionBtn.id);
                }
            } catch (error) {
                window.showToast(`Falha ao gerar Descri√ß√£o: ${error.message}`);
                console.error("Error generating Video Description.", error);
            } finally {
                hideLoading(buttons.generateDescriptionBtn);
                updateButtonStates();
            }
        };

        /**
         * Gera o esbo√ßo estrat√©gico do roteiro.
         */
        const generateStrategicOutline = async () => {
            if (!validateInputs()) return;
            showLoading(buttons.generateOutlineBtn);
            const outlineContentDiv = elements.outlineContent;
            outlineContentDiv.innerHTML = `<div class="loading-spinner-small mx-auto"></div>`;

            try {
                const { prompt, maxTokens } = constructScriptPrompt('outline', 'Esbo√ßo Estrat√©gico');
                const result = await callGroqAPI(prompt, maxTokens); // Use maxTokens from constructScriptPrompt
                const cleanedResult = cleanGeneratedText(result, true);

                if (!cleanedResult) throw new Error("A IA n√£o retornou um JSON v√°lido para o esbo√ßo.");

                strategicOutline = JSON.parse(cleanedResult); // Armazena o esbo√ßo globalmente
                
                // Formata o esbo√ßo para exibi√ß√£o com t√≠tulos traduzidos
                const titleTranslations = {
                    'introduction': 'Introdu√ß√£o',
                    'development': 'Desenvolvimento',
                    'climax': 'Cl√≠max',
                    'conclusion': 'Conclus√£o',
                    'cta': 'CTA'
                };
                let outlineHtml = '<ul class="list-disc list-inside space-y-2 text-sm">';
                for (const key in strategicOutline) {
                    // Busca a tradu√ß√£o no nosso dicion√°rio, ou usa a chave original capitalizada como fallback
                    const translatedTitle = titleTranslations[key] || (key.charAt(0).toUpperCase() + key.slice(1));
                    
                    outlineHtml += `<li><strong class="font-semibold">${translatedTitle}:</strong> ${strategicOutline[key]}</li>`;
                }
                outlineHtml += '</ul>';
                outlineContentDiv.innerHTML = outlineHtml;

                markButtonAsCompleted(buttons.generateOutlineBtn.id);

            } catch (error) {
                window.showToast(`Falha ao gerar Esbo√ßo: ${error.message}`);
                console.error("Error generating Outline.", error);
                outlineContentDiv.innerHTML = `<div class="asset-card-placeholder text-red-500">Erro ao gerar o esbo√ßo. Tente novamente.</div>`;
            } finally {
                hideLoading(buttons.generateOutlineBtn);
                updateButtonStates();
            }
        };


        /**
         * Realiza o download do roteiro como PDF.
         */
        const downloadPdf = async () => {
            // 1. Criar um container tempor√°rio para a impress√£o
            let printContainer = document.createElement('div');
            printContainer.id = 'print-container';

            // 2. Coletar e formatar TODO o conte√∫do que queremos imprimir
            let htmlToPrint = `<h1 style="text-align: center; font-size: 22pt; margin-bottom: 24px;">${elements.videoTheme.value}</h1>`;

            // Adicionar o esbo√ßo estrat√©gico
            if (strategicOutline) {
                const titleTranslations = {
                    'introduction': 'Introdu√ß√£o',
                    'development': 'Desenvolvimento',
                    'climax': 'Cl√≠max',
                    'conclusion': 'Conclus√£o',
                    'cta': 'CTA'
                };
                htmlToPrint += `
                    <div class="print-section">
                        <div class="print-section-title">Esbo√ßo Estrat√©gico</div>
                        <div class="print-section-content">
                            <ul style="list-style-type: disc; padding-left: 20px;">`;
                for (const key in strategicOutline) {
                    const translatedTitle = titleTranslations[key] || (key.charAt(0).toUpperCase() + key.slice(1));
                    htmlToPrint += `<li><strong>${translatedTitle}:</strong> ${strategicOutline[key]}</li>`;
                }
                htmlToPrint += `</ul></div></div>`;
            }

            // Adicionar o roteiro principal
            document.querySelectorAll('#scriptSectionsContainer .accordion-item').forEach(item => {
                const title = item.querySelector('h3')?.textContent;
                const content = item.querySelector('.generated-content-wrapper')?.textContent;
                if (title && content) {
                    htmlToPrint += `
                        <div class="print-section">
                            <div class="print-section-title">${title}</div>
                            <div class="print-section-content"><pre>${content}</pre></div>
                        </div>`;
                }
            });
            
            // Adicionar Descri√ß√£o e Hashtags
            const videoDescriptionContent = document.getElementById('videoDescriptionContent');
            if (videoDescriptionContent && videoDescriptionContent.textContent.trim() !== 'Clique em \'Gerar\' para ver a descri√ß√£o') {
                htmlToPrint += `
                    <div class="print-section">
                        <div class="print-section-title">Descri√ß√£o & Hashtags</div>
                        <div class="print-section-content">${videoDescriptionContent.innerHTML}</div>
                    </div>`;
            }

            // Adicionar T√≠tulos e Thumbnails
            const titlesThumbnailsContent = document.getElementById('titlesThumbnailsContent');
            if (titlesThumbnailsContent && titlesThumbnailsContent.textContent.trim() !== 'Clique em \'Gerar\' para ver as sugest√µes') {
                htmlToPrint += `
                    <div class="print-section">
                        <div class="print-section-title">T√≠tulos & Thumbnails</div>
                        <div class="print-section-content">${titlesThumbnailsContent.innerHTML}</div>
                    </div>`;
            }

            // 3. Injetar o HTML no container e adicion√°-lo ao body
            printContainer.innerHTML = htmlToPrint;
            document.body.appendChild(printContainer);

            // 4. Chamar a impress√£o
            window.print();

            // 5. Remover o container tempor√°rio ap√≥s a impress√£o (com um pequeno atraso para garantir a renderiza√ß√£o)
            setTimeout(() => {
                document.body.removeChild(printContainer);
            }, 500); // 500ms de atraso
        };

        /**
         * Reseta o estado da aplica√ß√£o para um novo roteiro.
         */
        const resetApplicationState = () => {
            // Reseta todos os inputs para seus valores padr√£o
            elements.channelName.value = 'The Biblical Unveiling'; // Valor padr√£o
            elements.videoTheme.value = '';
            elements.videoDescription.value = '';
            elements.targetAudience.value = 'Pessoas Interessadas em Arqueologia B√≠blica e Hist√≥ria Antiga, Crist√£os e Pessoas de F√©, Entusiastas de Ci√™ncia e Ceticismo (com mente aberta), Curiosos em Geral e Amantes de Mist√©rios.'; // Valor padr√£o
            elements.languageSelect.value = 'en';
            elements.languageStyle.value = 'inspirador';
            elements.videoObjective.value = 'informar';
            elements.videoDuration.value = '';
            elements.speakingPace.value = 'moderate';
            document.getElementById('narrativeGoal').value = 'storytelling'; // Reseta o novo seletor
            updateNarrativeStructureOptions(); // Atualiza as op√ß√µes de estrutura
            elements.centralQuestion.value = '';
            elements.emotionalArc.value = '';
            // REMOVIDO: elements.viralElements.value = '';
            elements.imageDescriptionEngine.value = '';
            elements.imageStyleSelect.value = 'cinematic';
            elements.customImageStyle.value = '';
            toggleCustomImageStyleVisibility();
            // Resetar os novos campos
            elements.narrativeTheme.value = '';
            elements.narrativeTone.value = 'inspirador';
            elements.narrativeVoice.value = '';

            // Limpa todas as vari√°veis de estado globais
            strategicOutline = null;
            allImagePrompts = {};
            generatedTitlesAndThumbnails = null;
            totalScriptSeconds = 0;

            // Limpa o HTML de todas as se√ß√µes de conte√∫do gerado
            document.querySelectorAll('#scriptColumn .script-section').forEach(sec => {
                sec.innerHTML = '';
            });
            elements.outlineContent.innerHTML = `<div class="asset-card-placeholder">Clique em 'Criar Esbo√ßo' para a IA planear a estrutura do roteiro.</div>`;
            document.getElementById('titlesThumbnailsContent').innerHTML = '<div class="asset-card-placeholder">Clique em \'Gerar\' para ver as sugest√µes</div>';
            document.getElementById('videoDescriptionContent').innerHTML = '<div class="asset-card-placeholder">Clique em \'Gerar\' para ver a descri√ß√£o</div>';
            
            // Limpa o conte√∫do do Centro Multicanal, se ele existir
            const repurposeOutput = document.getElementById('repurposeOutput');
            if(repurposeOutput) repurposeOutput.innerHTML = '';

            // Reseta os √≠cones e a barra de progresso
            resetCompletionIcons();
            updateProgressBar();
            
            // Esconde o painel principal, for√ßando o usu√°rio a gerar uma nova estrat√©gia
            elements.projectDashboard.classList.add('hidden');

            window.showToast("Pronto para um novo roteiro!");
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        /**
         * Exporta o estado atual do projeto para um ficheiro JSON.
         */
        const exportProject = () => {
            const projectData = {
                inputs: {},
                outputs: {},
                memory: {
                    allImagePrompts: allImagePrompts,
                    generatedTitlesAndThumbnails: generatedTitlesAndThumbnails,
                    strategicOutline: strategicOutline // Exporta o esbo√ßo
                }
            };

            // Salva o estado dos inputs
            for (const key in elements) {
                if (elements[key] && typeof elements[key].value !== 'undefined') {
                    projectData.inputs[key] = elements[key].value;
                }
            }
            // Salva o conte√∫do gerado (HTML interno das sec√ß√µes)
            const scriptSectionIds = ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection', 'ctaSection'];
            scriptSectionIds.forEach(id => {
                const sectionElement = document.getElementById(id);
                if (sectionElement) {
                    projectData.outputs[id] = sectionElement.innerHTML;
                }
            });

            // Salva o conte√∫do do esbo√ßo
            projectData.outputs.strategicOutlineContent = elements.outlineContent.innerHTML;

            // Salva o conte√∫do dos cart√µes de recursos
            projectData.outputs.titlesThumbnailsContent = document.getElementById('titlesThumbnailsContent').innerHTML;
            projectData.outputs.videoDescriptionContent = document.getElementById('videoDescriptionContent').innerHTML;
            // Removed storyboardContent export
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const fileName = elements.videoTheme.value.trim().replace(/[^a-zA-Z0-9]/gi, '_').toLowerCase() || 'roteiro_viral';
            downloadAnchorNode.setAttribute("download", `${fileName}_projeto.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            window.showToast("Projeto exportado com sucesso!");
        };

        /**
         * Renderiza os prompts de imagem para uma sec√ß√£o espec√≠fica na UI.
         * Usado ap√≥s carregar um projeto.
         * @param {string} sectionElementId - O ID do elemento HTML da sec√ß√£o.
         */
        const renderImagePromptsForSection = (sectionElementId) => {
            const sectionElement = document.getElementById(sectionElementId);
            if (!sectionElement) return;

            const promptContainer = sectionElement.querySelector('.prompt-container');
            if (!promptContainer) return;

            promptContainer.innerHTML = ''; // Limpa prompts existentes

            const promptsData = allImagePrompts[sectionElementId];
            if (promptsData && promptsData.length > 0) {
                promptsData.forEach((promptData, index) => { // Added index here for ID
                    const styleBlockContent = promptData.styleBlock || '';
                    const promptHtml = `
                        <div class="individual-prompt-block card-background">
                            <div class="flex items-center justify-between mb-2">
                                <p class="prompt-time">00:00 - Cena 00</p>
                                <button class="copy-btn" onclick="copyTextToClipboard(document.getElementById('prompt-content-${sectionElementId}-${index}').textContent + ' ' + document.getElementById('style-block-${sectionElementId}-${index}').textContent); window.showCopyFeedback(this)">Copiar</button>
                            </div>
                            <p class="prompt-phrase">${promptData.scriptPhrase}</p>
                            <p class="prompt-description-label">${imageDescriptionLabels[elements.languageSelect.value] || 'Image Description:'}</p>
                            <p id="prompt-content-${sectionElementId}-${index}" class="prompt-description-content">${promptData.imageDescription}</p>
                            <pre id="style-block-${sectionElementId}-${index}" class="text-xs p-2 rounded-md overflow-auto">${styleBlockContent}</pre>
                        </div>
                    `;
                    promptContainer.innerHTML += promptHtml;
                });
            } else {
                promptContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhum prompt gerado para esta sec√ß√£o.</p>';
            }
        };

        /**
         * Importa um projeto de um ficheiro JSON.
         * @param {Event} event - O evento de mudan√ßa do input de ficheiro.
         */
        const importProject = (event) => {
            const file = event.target.files[0];
            if (!file) { return; }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const projectData = JSON.parse(e.target.result);
                    
                    resetApplicationState();

                    for (const key in projectData.inputs) {
                        if (elements[key] && typeof elements[key].value !== 'undefined') {
                            elements[key].value = projectData.inputs[key];
                        }
                    }

                    const scriptSectionIds = ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection', 'ctaSection'];
                    scriptSectionIds.forEach(id => {
                        const sectionElement = document.getElementById(id);
                        if (sectionElement && projectData.outputs[id]) {
                            sectionElement.innerHTML = projectData.outputs[id];
                            sectionElement.classList.remove('hidden');
                            sectionElement.classList.add('animate-fade-in');
                        }
                    });

                    if (projectData.outputs.strategicOutlineContent) {
                        elements.outlineContent.innerHTML = projectData.outputs.strategicOutlineContent;
                    }
                    strategicOutline = projectData.memory.strategicOutline || null;

                    if (projectData.outputs.titlesThumbnailsContent) {
                        document.getElementById('titlesThumbnailsContent').innerHTML = projectData.outputs.titlesThumbnailsContent;
                    }
                    if (projectData.outputs.videoDescriptionContent) {
                        document.getElementById('videoDescriptionContent').innerHTML = projectData.outputs.videoDescriptionContent;
                    }
                    
                    allImagePrompts = projectData.memory.allImagePrompts || {};
                    generatedTitlesAndThumbnails = projectData.memory.generatedTitlesAndThumbnails || null;

                    updateButtonStates();
                    
                    if (elements.outlineContent.textContent.trim().length > 100) markButtonAsCompleted('generateOutlineBtn');
                    if (document.getElementById('introSection').innerHTML.trim()) markButtonAsCompleted('generateIntroBtn');
                    if (document.getElementById('developmentSection').innerHTML.trim()) markButtonAsCompleted('generateDevelopmentBtn');
                    if (document.getElementById('climaxSection').innerHTML.trim()) markButtonAsCompleted('climaxBtn');
                    if (document.getElementById('conclusionSection').innerHTML.trim()) markButtonAsCompleted('conclusionBtn');
                    if (document.getElementById('ctaSection').innerHTML.trim()) markButtonAsCompleted('generateCTABtn');
                    if (document.getElementById('videoDescriptionContent').innerHTML.includes('Hashtags')) markButtonAsCompleted('generateDescriptionBtn');
                    if (document.getElementById('titlesThumbnailsContent').innerHTML.includes('Analisar CTR')) markButtonAsCompleted('generateTitlesAndThumbnailsBtn');

                    // Re-renderiza os prompts de imagem para todas as sec√ß√µes
                    for (const sectionId in allImagePrompts) {
                        if (allImagePrompts.hasOwnProperty(sectionId)) {
                            renderImagePromptsForSection(sectionId);
                        }
                    }
                    // --- CHAMADA DA NOVA FUN√á√ÉO "MAESTRO" ---
                    // Garante a renumera√ß√£o correta ao importar um projeto.
                    reNumberAllScenes();

                    updateProgressBar(); 
                    elements.projectDashboard.classList.remove('hidden');
                    window.showToast("Projeto importado com sucesso!");

                } catch (err) {
                    window.showToast("Erro: Ficheiro de projeto inv√°lido ou corrompido.");
                    console.error("Erro ao importar projeto:", err);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        };

        /**
	 * Analisa o tema e a descri√ß√£o do v√≠deo para definir a estrat√©gia de conte√∫do.
         */
        const analyzeAndSetStrategy = async () => {
            const theme = elements.videoTheme.value.trim();
            const description = elements.videoDescription.value.trim();

            if (!theme || !description) {
                window.showToast("Por favor, preencha o Tema e a Descri√ß√£o do V√≠deo.");
                return;
            }
            
            // Zera o estado do painel de resultados ANTES de gerar uma nova estrat√©gia
            resetApplicationState();
            // Restaura os valores que o usu√°rio acabou de digitar, pois o reset os apagou
            elements.videoTheme.value = theme;
            elements.videoDescription.value = description;
            
            const button = buttons.analyzeStrategyBtn;
            showLoading(button);

            // Op√ß√µes v√°lidas para cada campo
            const languageStyleOptions = Array.from(elements.languageStyle.options).map(o => o.value).join(', ');
            const videoObjectiveOptions = Array.from(elements.videoObjective.options).map(o => o.value).join(', ');
            
            // Agrega todas as op√ß√µes de estrutura para o prompt
            const allStructures = {...narrativeStructures.storytelling, ...narrativeStructures.storyselling};
            const narrativeStructureOptions = Object.keys(allStructures).join(', ');

            const prompt = `Voc√™ √© um Estrategista de Conte√∫do de IA para o YouTube. Analise o tema e a descri√ß√£o e defina a melhor estrat√©gia.

            Tema do V√≠deo: "${theme}"
            Descri√ß√£o: "${description}"

            Responda APENAS com um objeto JSON v√°lido com as seguintes chaves:
            1. "target_audience": (string) O p√∫blico-alvo ideal.
            2. "language_style": (string) O melhor estilo de linguagem da lista: [${languageStyleOptions}].
            3. "video_objective": (string) O objetivo principal. DEVE SER um valor EXATO da lista: [${videoObjectiveOptions}].
            4. "narrative_goal": (string) O objetivo narrativo principal. Escolha entre 'storytelling' ou 'storyselling'.
            5. "narrative_structure": (string) Baseado no objetivo, a melhor estrutura da lista: [${narrativeStructureOptions}].
            6. "central_question": (string) A pergunta central mais intrigante.
            7. "emotional_arc": (string) O arco emocional ideal (Ex: Curiosidade -> Tens√£o -> Inspira√ß√£o).
            
            Seja coeso e eficaz.`;

            try {
                const rawResult = await callGroqAPI(prompt, 1500);
                const cleanedResult = cleanGeneratedText(rawResult, true);
                const strategy = JSON.parse(cleanedResult);

                // Preenche os campos da interface com a resposta da IA
                if(strategy.target_audience) elements.targetAudience.value = strategy.target_audience;
                if(strategy.language_style) elements.languageStyle.value = strategy.language_style;
                if (strategy.video_objective) {
                    const objectiveSelect = elements.videoObjective;
                    const returnedValue = strategy.video_objective.trim();
                    const validOptions = Array.from(objectiveSelect.options).map(opt => opt.value);
                    if (validOptions.includes(returnedValue)) {
                        objectiveSelect.value = returnedValue;
                    } else {
                        console.warn(`IA retornou um 'video_objective' inv√°lido: '${returnedValue}'. Usando o padr√£o 'informar'.`);
                        objectiveSelect.value = 'informar'; 
                    }
                }
                
                // Preenche os novos seletores de narrativa
                if(strategy.narrative_goal) {
                    elements.narrativeGoal.value = strategy.narrative_goal;
                    updateNarrativeStructureOptions(); // Atualiza o segundo dropdown
                }
                if(strategy.narrative_structure) elements.narrativeStructure.value = strategy.narrative_structure;

                if(strategy.central_question) elements.centralQuestion.value = strategy.central_question;
                if(strategy.emotional_arc) elements.emotionalArc.value = strategy.emotional_arc;

                window.showToast("Estrat√©gia definida com sucesso!");
                elements.projectDashboard.classList.remove('hidden');

            } catch (error) {
                window.showToast(`Falha ao definir estrat√©gia: ${error.message}`);
                console.error("Erro na an√°lise estrat√©gica:", error);
                // Restaura os valores em caso de erro para o usu√°rio n√£o perder o que digitou
                elements.videoTheme.value = theme;
                elements.videoDescription.value = description;
            } finally {
                hideLoading(button);
            }
        };

        /**
         * Controla a visibilidade e o conte√∫do da barra de a√ß√µes flutuante com base na rolagem.
         */
        window.handleFloatingActionBar = () => {
            const mainActions = document.getElementById('mainActions');
            const quickActions = document.getElementById('quickActions');
            const projectDashboard = document.getElementById('projectDashboard'); 
            
            if (!projectDashboard) return;

            const actionBar = elements.floatingActionBar;
            // Ponto de gatilho para a barra flutuante (um pouco antes da √°rea de output)
            const triggerPoint = projectDashboard.offsetTop - actionBar.offsetHeight - 50; // 50px de buffer

            if (window.scrollY > triggerPoint) {
                // Se rolou para a √°rea de resultados, mostra a barra e as A√ß√µes R√°pidas
                actionBar.classList.add('visible');
                mainActions.classList.add('hidden');
                quickActions.classList.remove('hidden');
            } else if (window.scrollY > 150) { // Um pequeno buffer para n√£o aparecer imediatamente no topo
                // Se rolou um pouco, mas n√£o chegou nos resultados, mostra a barra com as A√ß√µes Principais
                actionBar.classList.add('visible');
                mainActions.classList.remove('hidden');
                quickActions.classList.add('hidden');
            } else {
                // Se est√° no topo, esconde a barra
                actionBar.classList.remove('visible');
            }
        };

        /**
         * Alterna o estado de um acorde√£o (abrir/fechar).
         * @param {string} bodyId - O ID do corpo do acorde√£o.
         * @param {string} arrowId - O ID do √≠cone de seta do acorde√£o.
         */
        window.toggleAccordion = (bodyId, arrowId) => {
            const body = document.getElementById(bodyId);
            const arrow = document.getElementById(arrowId);
            if (body && arrow) {
                body.classList.toggle('open');
                arrow.classList.toggle('open');
                // Adiciona ou remove a classe 'active' no elemento pai do cabe√ßalho
                // Para acorde√µes aninhados, o header √© o pr√≥prio elemento clicado.
                // Para o acorde√£o principal, √© o pai do header-content.
                const headerElement = arrow.closest('.accordion-header') || arrow.closest('.nested-accordion-header');
                if (headerElement) {
                    headerElement.classList.toggle('active');
                }
            }
        };

        // ==========================================================
        // NOVA FUN√á√ÉO PARA ATUALIZAR A BARRA DE PROGRESO
        // ==========================================================
        const updateProgressBar = () => {
            // Lista de todas as tarefas que contam para o progresso
            const taskButtonIds = [
                'generateOutlineBtn', 
                'generateIntroBtn', 'generateDevelopmentBtn', 'climaxBtn', 
                'conclusionBtn', 'generateCTABtn', 'generateDescriptionBtn', 
                'generateTitlesAndThumbnailsBtn' 
            ];
            const totalTasks = taskButtonIds.length;

            let completedTasks = 0;
            taskButtonIds.forEach(id => {
                const button = document.getElementById(id);
                // Check if the button is marked as success (meaning content was generated)
                if (button && button.classList.contains('btn-success')) {
                    completedTasks++;
                }
            });

            const percentage = Math.round((completedTasks / totalTasks) * 100);

            // Atualiza a UI
            if (elements.progressBar && elements.progressText) {
                elements.progressBar.style.width = `${percentage}%`;
                elements.progressText.textContent = `${percentage}%`;

                if (percentage === 100) {
                    elements.progressBar.textContent = "Projeto Pronto!"; 
                    elements.progressBar.style.backgroundColor = 'var(--primary-color)';
                } else {
                     // Garante que a cor volte ao verde se n√£o for 100%
                    elements.progressBar.style.backgroundColor = 'var(--success-color)';
                }
            }
        };

        // ==========================================================
        // ================== INICIALIZA√á√ÉO =======================
        // ==========================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Content Loaded. Initializing app."); 
            
            // Adiciona as novas refer√™ncias de elementos
            elements.progressBar = document.getElementById('progressBar');
            elements.progressText = document.getElementById('progressText');
            elements.projectDashboard = document.getElementById('projectDashboard'); 
            elements.outlineContent = document.getElementById('outlineContent'); 
            elements.audioPlayer = document.getElementById('audioPlayer'); // Refer√™ncia ao player de √°udio

            // --- IN√çCIO DOS LISTENERS DO NOVO M√ìDULO DE NARRATIVA ---

            // Adiciona as novas refer√™ncias de elementos que n√£o s√£o bot√µes
            elements.narrativeGoal = document.getElementById('narrativeGoal');
            elements.narrativeStructure = document.getElementById('narrativeStructure');
            elements.narrativeStructureTooltip = document.getElementById('narrativeStructureTooltip');

            // --- ADICIONE AS LINHAS ABAIXO ---
            elements.narrativeTheme = document.getElementById('narrativeTheme');
            elements.narrativeTone = document.getElementById('narrativeTone');
            elements.narrativeVoice = document.getElementById('narrativeVoice');
            // --- FIM DAS LINHAS A SEREM ADICIONADAS ---

            // Listener para o seletor de objetivo
            if (elements.narrativeGoal) {
                elements.narrativeGoal.addEventListener('change', updateNarrativeStructureOptions);
            }

            // Inicializa as op√ß√µes pela primeira vez quando a p√°gina carrega
            updateNarrativeStructureOptions();

            // --- FIM DOS LISTENERS ---

            // Configura os event listeners para os bot√µes
            const setupClick = (originalId) => {
                const floatBtn = document.getElementById(`float_${originalId}`);
                if (floatBtn) {
                    floatBtn.addEventListener('click', () => {
                        document.getElementById(originalId).click();
                    });
                }
            };

            // Conecta os bot√µes flutuantes aos originais
            // Iterar sobre todos os bot√µes que t√™m um flutuante correspondente
            const allButtonIds = Object.keys(buttons);
            allButtonIds.forEach(id => {
                // Exclui o bot√£o do modo zen da barra flutuante, pois ele foi movido
                if (id.startsWith('generate') || id.startsWith('climax') || id.startsWith('conclusion') || id.startsWith('cta') || id.startsWith('download') || id.startsWith('reset') || id.startsWith('export') || id.startsWith('import')) {
                    setupClick(id);
                }
            });
            
            // Adiciona os listeners de a√ß√£o aos bot√µes originais
            if (buttons.generateOutlineBtn) buttons.generateOutlineBtn.addEventListener('click', generateStrategicOutline); 
            if (buttons.generateIntroBtn) buttons.generateIntroBtn.addEventListener('click', () => handleGenerateSection(buttons.generateIntroBtn, 'intro', 'Introdu√ß√£o', 'intro'));
            if (buttons.generateDevelopmentBtn) buttons.generateDevelopmentBtn.addEventListener('click', () => handleGenerateSection(buttons.generateDevelopmentBtn, 'development', 'Desenvolvimento', 'development'));
            if (buttons.climaxBtn) buttons.climaxBtn.addEventListener('click', () => handleGenerateSection(buttons.climaxBtn, 'climax', 'Cl√≠max', 'climax'));
            if (buttons.conclusionBtn) buttons.conclusionBtn.addEventListener('click', () => handleGenerateSection(buttons.conclusionBtn, 'conclusion', 'Conclus√£o', 'conclusion'));
            if (buttons.generateCTABtn) buttons.generateCTABtn.addEventListener('click', () => handleGenerateSection(buttons.generateCTABtn, 'cta', 'Chamada para A√ß√£o', 'cta'));
            if (buttons.generateTitlesAndThumbnailsBtn) buttons.generateTitlesAndThumbnailsBtn.addEventListener('click', generateTitlesAndThumbnails);
            if (buttons.generateDescriptionBtn) buttons.generateDescriptionBtn.addEventListener('click', generateVideoDescription);
            // Removed storyboard button listener
            if (buttons.resetScriptBtn) buttons.resetScriptBtn.addEventListener('click', resetApplicationState);
            if (buttons.downloadPdfBtn) buttons.downloadPdfBtn.addEventListener('click', downloadPdf); 
            if (buttons.exportProjectBtn) buttons.exportProjectBtn.addEventListener('click', exportProject); 
            if (buttons.copyTranscriptBtn) buttons.copyTranscriptBtn.addEventListener('click', handleCopyAndDownloadTranscript); 
            
            // Outros listeners
            if (buttons.fullScreenAlertCloseBtn) buttons.fullScreenAlertCloseBtn.addEventListener('click', hideFullScreenAlert); 
            if (elements.imageStyleSelect) elements.imageStyleSelect.addEventListener('change', toggleCustomImageStyleVisibility);
            
            // NOVO C√ìDIGO √Ä PROVA DE BALAS PARA O MODO ESCURO
            const darkModeButton = document.getElementById('darkModeToggle');
            if (darkModeButton) {
                darkModeButton.addEventListener('click', () => {
                    const moonIcon = document.getElementById('moonIcon');
                    const sunIcon = document.getElementById('sunIcon');
                    
                    // Alterna a classe 'dark' no body
                    document.body.classList.toggle('dark');

                    // Verifica se o modo escuro est√° ATIVO agora
                    if (document.body.classList.contains('dark')) {
                        // Se SIM, esconde a lua, mostra o sol, e salva no localStorage
                        if (moonIcon) moonIcon.classList.add('hidden');
                        if (sunIcon) sunIcon.classList.remove('hidden');
                        localStorage.setItem('darkMode', 'enabled');
                    } else {
                        // Se N√ÉO, esconde o sol, mostra a lua, e salva no localStorage
                        if (moonIcon) moonIcon.classList.remove('hidden');
                        if (sunIcon) sunIcon.classList.add('hidden'); 
                        localStorage.setItem('darkMode', 'disabled');
                    }
                });
            }
            // Adicione esta linha dentro do DOMContentLoaded, fora de qualquer listener
            if (localStorage.getItem('darkMode') === 'enabled') {
                const moonIcon = document.getElementById('moonIcon');
                const sunIcon = document.getElementById('sunIcon');
                document.body.classList.add('dark');
                if (moonIcon) moonIcon.classList.add('hidden');
                if (sunIcon) sunIcon.classList.remove('hidden');
            }

            if (buttons.analyzeStrategyBtn) buttons.analyzeStrategyBtn.addEventListener('click', analyzeAndSetStrategy);
            if (buttons.importProjectBtn) {
                buttons.importProjectBtn.addEventListener('click', () => elements.importFileInput.click());
                elements.importFileInput.addEventListener('change', importProject);
            }

            // L√≥gica para o Modo Zen
            const zenModeBtn = document.getElementById('toggleZenModeBtn');
            if (zenModeBtn) {
                zenModeBtn.addEventListener('click', () => {
                    document.body.classList.toggle('zen-mode');
                });
            }

            const exitZenModeBtn = document.getElementById('exitZenModeBtn');
            if (exitZenModeBtn) {
                exitZenModeBtn.addEventListener('click', () => {
                    document.body.classList.remove('zen-mode');
                });
            }

            // Define o estado inicial dos bot√µes
            updateButtonStates();
            // Adiciona o listener de rolagem para a barra flutuante
            window.addEventListener('scroll', window.handleFloatingActionBar);
            updateProgressBar(); 
        });
    </script>
</body>
</html>